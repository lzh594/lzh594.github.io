<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>爬虫笔记 | lzhのBLOG</title><meta name="author" content="£·"><meta name="copyright" content="£·"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="第1章 初识爬虫 1.1 第一个爬虫程序 12345678910111213# 爬虫：从互联网获取所需资源# 需求：用程序模拟浏览器，输入一个网址，从该网址中获取到资源或内容from urllib.request import urlopenurl &#x3D; &quot;http:&#x2F;&#x2F;www.baidu.com&quot;  # 网址变量resp &#x3D; urlopen(url)# print(resp.r">
<meta property="og:type" content="article">
<meta property="og:title" content="爬虫笔记">
<meta property="og:url" content="https://lzh594.github.io/python/%E7%88%AC%E8%99%AB%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="lzhのBLOG">
<meta property="og:description" content="第1章 初识爬虫 1.1 第一个爬虫程序 12345678910111213# 爬虫：从互联网获取所需资源# 需求：用程序模拟浏览器，输入一个网址，从该网址中获取到资源或内容from urllib.request import urlopenurl &#x3D; &quot;http:&#x2F;&#x2F;www.baidu.com&quot;  # 网址变量resp &#x3D; urlopen(url)# print(resp.r">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lzh594.github.io/images/funingna.jpeg">
<meta property="article:published_time" content="2024-02-25T10:05:06.000Z">
<meta property="article:modified_time" content="2024-02-25T10:13:14.405Z">
<meta property="article:author" content="£·">
<meta property="article:tag" content="crawl">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lzh594.github.io/images/funingna.jpeg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://lzh594.github.io/python/%E7%88%AC%E8%99%AB%E7%AC%94%E8%AE%B0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '爬虫笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-02-25 18:13:14'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.0.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/touxiang1.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">23</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/About/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/images/funingna.jpeg')"><nav id="nav"><span id="blog-info"><a href="/" title="lzhのBLOG"><span class="site-name">lzhのBLOG</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/About/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">爬虫笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-02-25T10:05:06.000Z" title="发表于 2024-02-25 18:05:06">2024-02-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-02-25T10:13:14.405Z" title="更新于 2024-02-25 18:13:14">2024-02-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/python/">python</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/python/crawl/">crawl</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>49分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="爬虫笔记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="第1章-初识爬虫">第1章 初识爬虫</h2>
<h3 id="1-1-第一个爬虫程序">1.1 第一个爬虫程序</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 爬虫：从互联网获取所需资源</span></span><br><span class="line"><span class="comment"># 需求：用程序模拟浏览器，输入一个网址，从该网址中获取到资源或内容</span></span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://www.baidu.com&quot;</span>  <span class="comment"># 网址变量</span></span><br><span class="line">resp = urlopen(url)</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(resp.read().decode(&quot;utf-8&quot;))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;mybaidu.html&quot;</span>, mode=<span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(resp.read().decode(<span class="string">&quot;utf-8&quot;</span>))  <span class="comment"># 读取网页源代码并保存为文件</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;over&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="1-2-web请求过程剖析">1.2 web请求过程剖析</h3>
<ul>
<li>服务器渲染：在服务器端直接把数据和html整合在一起，统一返回给浏览器——在源代码中有数据</li>
<li>客户端渲染：第一次请求只拿到html骨架。第二次请求拿到数据，进行数据展示——源代码中没数据</li>
<li>熟练使用浏览器抓包工具</li>
</ul>
<h3 id="1-3-HTTP协议">1.3 HTTP协议</h3>
<p><strong>协议</strong>：</p>
<p>就是两个计算机之间为了能够流畅的进行沟通而设置的一个君子协定。常见的有TCP/IP.SOAP协议，HTTP协议、SMTP协议等</p>
<p><strong>HTTP</strong>协议：</p>
<p>（Hyper Text Transfer Protocol）指超文本传输协议，是用于从万维网（www：，world wide web）服务器传输超文本到本地浏览器的传送协议，直白点，是浏览器和服务器之间的数据交互遵守的协议</p>
<p><strong>HTTP协议把一条消息分为三大块消息（无论是请求还是响应）</strong></p>
<p><strong>请求</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">请求行 -&gt; 请求方式（Request Method）（get/post） 请求URL地址 协议</span><br><span class="line">请求头（Request Headers）	-&gt; 放一些服务器使用的附加信息</span><br><span class="line">	User-Agent：请求载体的身份标识（用啥发送的请求）</span><br><span class="line">	Referer：防盗链（这次请求是从哪个页面来的）（反爬会用）</span><br><span class="line">	Cookie：本地字符串数据信息（用户登录信息、反爬的token）</span><br><span class="line">请求体	-&gt; 一般放一些请求参数</span><br></pre></td></tr></table></figure>
<p><strong>响应</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">状态行 -&gt; 协议 状态码（Status Code）（404等）</span><br><span class="line">响应头（Response Headers） -&gt; 放一些客户端要使用的一些附加信息</span><br><span class="line">	cookie：本地字符串数据信息（用户登录信息、反爬的token）</span><br><span class="line">	各种神奇的莫名其妙的字符串（依赖经验，一般都是token字样，防止各种攻击和反爬）</span><br><span class="line">响应体 -&gt; 服务器返回的真正客户端要用的内容（HTML、json）等</span><br></pre></td></tr></table></figure>
<p><strong>请求方式</strong>：</p>
<p>GET：显示提交</p>
<p>POST：隐式提交</p>
<h3 id="1-4-requests入门01">1.4 requests入门01</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装requests</span></span><br><span class="line"><span class="comment"># pip install requests</span></span><br><span class="line"><span class="comment"># 网速较慢时，国内镜像（清华源）</span></span><br><span class="line"><span class="comment"># pip install -i https://pypi.tuna.tsinghua.edu.cn/simple requests</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">query = <span class="built_in">input</span>(<span class="string">&quot;请输入你要搜索的一个关键词：&quot;</span>)</span><br><span class="line">url = <span class="string">f&#x27;http://www.sogou.com/web?query=<span class="subst">&#123;query&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.0.0 Safari/537.36&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">resp = requests.get(url, headers=header)  <span class="comment"># 处理一个小反爬：说明自己是浏览器</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(resp)  <span class="comment"># &lt;Response [200]&gt;</span></span><br><span class="line"><span class="built_in">print</span>(resp.text)  <span class="comment"># 拿到页面源代码 -&gt; 用户您好，我们的系统检测到您网络中存在异常访问请求。</span></span><br></pre></td></tr></table></figure>
<h3 id="1-5-requests入门02">1.5 requests入门02</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;https://fanyi.baidu.com/sug&quot;</span></span><br><span class="line">s = <span class="built_in">input</span>(<span class="string">&quot;请输入你要翻译的英文单词：&quot;</span>)</span><br><span class="line">dat = &#123;</span><br><span class="line">    <span class="string">&quot;kw&quot;</span>: s  <span class="comment"># Payload中的From Data</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 发送post请求,发送的数据必须放在字典中，通过data参数进行传递</span></span><br><span class="line">resp = requests.post(url, data=dat)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(resp.json())  <span class="comment"># 将服务器返回的内容直接处理成json() =&gt; dict</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="1-6-requests入门03">1.6 requests入门03</h3>
<p><strong>XHR</strong>:（XMLHttpRqquest）</p>
<p><strong>URL</strong>：'?'前面为网址，后面为参数（可以在Query String Parameters中看到）</p>
<p><img src="/python/%E7%88%AC%E8%99%AB%E7%AC%94%E8%AE%B0/image-20220812215805500.png" alt="image-20220812215805500"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># url = &quot;https://movie.douban.com/j/chart/top_list?type=24&amp;interval_id=100%3A90&amp;action=&amp;start=0&amp;limit=20&quot;</span></span><br><span class="line">url = <span class="string">&quot;https://movie.douban.com/j/chart/top_list&quot;</span></span><br><span class="line"><span class="comment"># url过长</span></span><br><span class="line"><span class="comment"># 重新封装参数</span></span><br><span class="line">param = &#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;24&quot;</span>,</span><br><span class="line">    <span class="string">&quot;interval_id&quot;</span>: <span class="string">&quot;100:90&quot;</span>,</span><br><span class="line">    <span class="string">&quot;action&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;start&quot;</span>: <span class="number">0</span>,  <span class="comment"># 排名起始段</span></span><br><span class="line">    <span class="string">&quot;limit&quot;</span>: <span class="number">20</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 后补充headers</span></span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.0.0 Safari/537.36&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resp = requests.get(url=url, params=param,headers=header)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(resp.request.url)</span><br><span class="line"><span class="comment"># 获得https://movie.douban.com/j/chart/top_list?type=24&amp;interval_id=100%3A90&amp;action=&amp;start=0&amp;limit=20</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(resp.text)</span><br><span class="line"><span class="comment"># 无headers时无反应：说明被反爬，先看User-Agent</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认User-Agent（不设置headers时测试）</span></span><br><span class="line"><span class="built_in">print</span>(resp.request.headers)</span><br><span class="line"><span class="comment"># &#123;&#x27;User-Agent&#x27;: &#x27;python-requests/2.28.1&#x27;, &#x27;Accept-Encoding&#x27;: &#x27;gzip, deflate&#x27;, &#x27;Accept&#x27;: &#x27;*/*&#x27;, &#x27;Connection&#x27;: &#x27;keep-alive&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(resp.json())</span><br></pre></td></tr></table></figure>
<h3 id="1-7-补充">1.7 补充</h3>
<ul>
<li>关掉resp, 避免请求次数过多，使用close方法关闭</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&quot;https://movie.douban.com&quot;</span></span><br><span class="line">resp = requests.get(url=url)</span><br><span class="line">resp.close()</span><br></pre></td></tr></table></figure>
<ul>
<li>open的编码问题: mac默认utf-8, win为gbk</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">open</span>(<span class="string">&quot;xxx.txt&quot;</span>, mode=<span class="string">&quot;w&quot;</span>, encoding = <span class="string">&quot;gbk/utf-8&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="第2章-数据解析与提取">第2章 数据解析与提取</h2>
<h3 id="2-1-数据解析概述">2.1 数据解析概述</h3>
<p>三种解析方式：</p>
<ol>
<li>re解析</li>
<li>bs4解析（性能慢）</li>
<li>xpath解析</li>
</ol>
<p>​		三种方式可以混合使用，完全以结果做导向，只要能拿到想要的数据，用什么方案不重要，当掌握了这些之后再考虑性能问题</p>
<h3 id="2-2-正则表达式">2.2 正则表达式</h3>
<p><strong>Regular Expression：</strong></p>
<p>正则表达式，一种使用表达式方式对字符串进行匹配的语法规则</p>
<p>我们抓取到的网页源代码本质上是一个超长的字符串，想从里面提取内容，用正则再合适不过了</p>
<p>正则<strong>优点</strong>：速度快、效率高、准确性高</p>
<p>正则<strong>缺点</strong>：新手难度高</p>
<p>正则语法：使用元字符进行排列组合用来匹配字符串<a target="_blank" rel="noopener" href="https://tool.oschina.net/regex/">在线正则表达式测试</a></p>
<p><strong>元字符</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">.		匹配除换行符以外的任意字符</span><br><span class="line">\w	匹配字母数字下划线</span><br><span class="line">\d	匹配数字</span><br><span class="line">\n	匹配换行符</span><br><span class="line">\t	匹配制表符</span><br><span class="line"></span><br><span class="line">^		匹配字符串的开始</span><br><span class="line">$		匹配字符串的结尾</span><br><span class="line"></span><br><span class="line">\W	匹配非字母数字下划线</span><br><span class="line">\D	匹配非数字</span><br><span class="line">\S	匹配非空白符号</span><br><span class="line">a|b	匹配字符a或字符b</span><br><span class="line">()	匹配括号内的表达式，也表示一个组</span><br><span class="line">[...]		匹配字符组中字符</span><br><span class="line">[^...]	匹配除了字符组中的字符</span><br></pre></td></tr></table></figure>
<p><strong>量词</strong>：控制前面的元字符出现的次数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*		重复零次或更多次</span><br><span class="line">+		重复一次或更多次</span><br><span class="line">?		重复一次或多次(出现或不出现)</span><br><span class="line">&#123;n&#125;	至少匹配n次，n为非负整数</span><br><span class="line">&#123;n,m&#125;		最少匹配n次且最多匹配m次</span><br><span class="line">&#123;n,&#125;		重复n次或更多次</span><br></pre></td></tr></table></figure>
<p><img src="/python/%E7%88%AC%E8%99%AB%E7%AC%94%E8%AE%B0/image-20220814214842249.png" alt="image-20220814214842249"></p>
<p><strong>贪婪匹配和惰性匹配</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.*		贪婪匹配（多个匹配选最长）</span><br><span class="line">.*?		惰性匹配（多个匹配选最短）</span><br></pre></td></tr></table></figure>
<p><img src="/python/%E7%88%AC%E8%99%AB%E7%AC%94%E8%AE%B0/image-20220814215312211.png" alt="image-20220814215312211"></p>
<p><img src="/python/%E7%88%AC%E8%99%AB%E7%AC%94%E8%AE%B0/image-20220814215333031.png" alt="image-20220814215333031"></p>
<p><img src="/python/%E7%88%AC%E8%99%AB%E7%AC%94%E8%AE%B0/image-20220814220815226.png" alt="image-20220814220815226"></p>
<h3 id="2-3-re模块">2.3 re模块</h3>
<p>python中使用正则 -&gt; re模块</p>
<p>re模块常见功能</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="comment"># findall(正则, 字符串, flag)：匹配字符串中所有符合正则的内容(返回列表)</span></span><br><span class="line">lst = re.findall(<span class="string">r&quot;\d+&quot;</span>, <span class="string">&quot;我的电话是：10086&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;findall:&quot;</span>, lst)</span><br><span class="line"></span><br><span class="line"><span class="comment"># finditer:匹配字符串中所有的内容(返回迭代器,迭代器中拿到内容使用group())</span></span><br><span class="line">it = re.finditer(<span class="string">r&quot;\d+&quot;</span>, <span class="string">&quot;我的电话是：10086,我女朋友的电话是10010&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;finditer:&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> it:</span><br><span class="line">    <span class="built_in">print</span>(each.group())</span><br><span class="line"></span><br><span class="line"><span class="comment"># search找到第一个结果返回match对象，那数据使用group()</span></span><br><span class="line">s = re.search(<span class="string">r&quot;\d+&quot;</span>, <span class="string">&quot;我的电话是：10086,我女朋友的电话是10010&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;search:&quot;</span>, s.group())</span><br><span class="line"><span class="comment"># match从头开始匹配</span></span><br><span class="line">s = re.<span class="keyword">match</span>(<span class="string">r&quot;\d+&quot;</span>, <span class="string">&quot;10086,我女朋友的电话是10010&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;match:&quot;</span>, s.group())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 预加载正则表达式(compile())</span></span><br><span class="line">obj = re.<span class="built_in">compile</span>(<span class="string">r&quot;\d+&quot;</span>)</span><br><span class="line">ret = obj.finditer(<span class="string">&quot;我的电话号码是：10086，我女朋友的电话是：10010&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;预加载：&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> it <span class="keyword">in</span> ret:</span><br><span class="line">    <span class="built_in">print</span>(it.group())</span><br><span class="line">ret = obj.findall(<span class="string">&quot;我的电话号码是：10086，我女朋友的电话是：10010&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br><span class="line"></span><br><span class="line">s = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;div class=&#x27;lzh&#x27;&gt;&lt;span id=&#x27;1&#x27;&gt;刘征昊&lt;/span&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;div class=&#x27;czy&#x27;&gt;&lt;span id=&#x27;2&#x27;&gt;陈石榴&lt;/span&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;div class=&#x27;wyz&#x27;&gt;&lt;span id=&#x27;3&#x27;&gt;王尖尖&lt;/span&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;div class=&#x27;xxq&#x27;&gt;&lt;span id=&#x27;4&#x27;&gt;kesiu&lt;/span&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;div class=&#x27;wyx&#x27;&gt;&lt;span id=&#x27;5&#x27;&gt;王冲冲&lt;/span&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># re.S可以使&#x27;.&#x27;匹配换行符</span></span><br><span class="line">obj = re.<span class="built_in">compile</span>(<span class="string">r&quot;&lt;div class=&#x27;.*?&#x27;&gt;&lt;span id=&#x27;\d+&#x27;&gt;.*?&lt;/span&gt;&lt;/div&gt;&quot;</span>, re.S)</span><br><span class="line">result = obj.finditer(s)</span><br><span class="line"><span class="keyword">for</span> it <span class="keyword">in</span> result:</span><br><span class="line">    <span class="built_in">print</span>(it.group())</span><br><span class="line"><span class="comment"># (?P&lt;xxx&gt;正则)可以从正则字符串中进一步提取内容并存在xxx里</span></span><br><span class="line">obj = re.<span class="built_in">compile</span>(<span class="string">r&quot;&lt;div class=&#x27;.*?&#x27;&gt;&lt;span id=&#x27;\d+&#x27;&gt;(?P&lt;name&gt;.*?)&lt;/span&gt;&lt;/div&gt;&quot;</span>, re.S)</span><br><span class="line">result = obj.finditer(s)</span><br><span class="line"><span class="keyword">for</span> it <span class="keyword">in</span> result:</span><br><span class="line">    <span class="built_in">print</span>(it.group(<span class="string">&quot;name&quot;</span>))</span><br></pre></td></tr></table></figure>
<h3 id="2-4-re实例">2.4 re实例</h3>
<h4 id="2-4-1-手刃豆瓣TOP250">2.4.1 手刃豆瓣TOP250</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拿到页面源代码   requests</span></span><br><span class="line"><span class="comment"># 通过re来提取想要的有效信息 re</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">start = <span class="number">0</span></span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.0.0 Safari/537.36&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">os.remove(<span class="string">&quot;data.csv&quot;</span>)  <span class="comment"># 删除旧文件</span></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;data.csv&quot;</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> start &lt;= <span class="number">225</span>:</span><br><span class="line">    url = <span class="string">f&quot;https://movie.douban.com/top250?start=<span class="subst">&#123;start&#125;</span>&amp;filter=&quot;</span></span><br><span class="line">    start += <span class="number">25</span></span><br><span class="line">    resp = requests.get(url, headers=header)</span><br><span class="line">    page_content = resp.text</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 解析数据</span></span><br><span class="line">    obj = re.<span class="built_in">compile</span>(<span class="string">r&#x27;&lt;li&gt;.*?&lt;div class=&quot;item&quot;&gt;.*?&lt;span class=&quot;title&quot;&gt;(?P&lt;name&gt;.*?)&#x27;</span></span><br><span class="line">                     <span class="string">r&#x27;&lt;/span&gt;.*?&lt;p class=&quot;&quot;&gt;.*?&lt;br&gt;(?P&lt;year&gt;.*?)&amp;nbsp.*?&#x27;</span></span><br><span class="line">                     <span class="string">r&#x27;&lt;span class=&quot;rating_num&quot; property=&quot;v:average&quot;&gt;(?P&lt;score&gt;.*?)&lt;/span&gt;&#x27;</span></span><br><span class="line">                     <span class="string">r&#x27;.*?&lt;span&gt;(?P&lt;num&gt;.*?)人评价&lt;/span&gt;&#x27;</span>, re.S)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># &lt;li&gt;.*?&lt;div class=&quot;item&quot;&gt;为一体判断，中间用于过滤换行符等</span></span><br><span class="line">    <span class="comment"># 开始匹配</span></span><br><span class="line">    result = obj.finditer(page_content)</span><br><span class="line">    csvWriter = csv.writer(f)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> it <span class="keyword">in</span> result:</span><br><span class="line">        <span class="comment"># print(it.group(&quot;name&quot;))</span></span><br><span class="line">        <span class="comment"># print(it.group(&quot;year&quot;).strip())  # 处理空格</span></span><br><span class="line">        <span class="comment"># print(it.group(&quot;score&quot;))</span></span><br><span class="line">        <span class="comment"># print(it.group(&quot;num&quot;))</span></span><br><span class="line">        dic = it.groupdict()</span><br><span class="line">        dic[<span class="string">&quot;year&quot;</span>] = dic[<span class="string">&quot;year&quot;</span>].strip()</span><br><span class="line">        csvWriter.writerow(dic.values())</span><br><span class="line">f.close()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;over!&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="2-4-2-屠戮电影天堂">2.4.2 屠戮电影天堂</h4>
<p>html中<strong>a标签</strong>表示<strong>超链接</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;xxx&#x27;</span>, <span class="attr">title</span>=<span class="string">&#x27;yyy&#x27;</span>&gt;</span>zzz<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>链接地址(href):xxx    链接预览(title):yyy    链接名称:zzz</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.定位到2020必看片(2022必看热片)</span></span><br><span class="line"><span class="comment"># 2.从中提取子页面的链接地址</span></span><br><span class="line"><span class="comment"># 3.请求子页面链接地址,拿到我们想要的下载地址</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">domain = <span class="string">&quot;https://www.dytt89.com/&quot;</span></span><br><span class="line">resp = requests.get(domain, verify=<span class="literal">False</span>)</span><br><span class="line">resp.encoding = <span class="string">&#x27;gb2312&#x27;</span>  <span class="comment"># 指定字符集</span></span><br><span class="line"><span class="comment"># verify=False去掉安全验证</span></span><br><span class="line"><span class="comment"># print(resp.text)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拿到ul里面的li</span></span><br><span class="line">obj1 = re.<span class="built_in">compile</span>(<span class="string">r&quot;2022必看热片.*?&lt;ul&gt;(?P&lt;ul&gt;.*?)&lt;/ul&gt;&quot;</span>, re.S)</span><br><span class="line">obj2 = re.<span class="built_in">compile</span>(<span class="string">r&quot;&lt;a href=&#x27;(?P&lt;href&gt;.*?)&#x27;&quot;</span>, re.S)</span><br><span class="line">obj3 = re.<span class="built_in">compile</span>(<span class="string">r&#x27;◎片　　名(?P&lt;movie&gt;.*?)&lt;br /&gt;.*?&lt;td style=&quot;WORD-WRAP: &#x27;</span></span><br><span class="line">                  <span class="string">r&#x27;break-word&quot; bgcolor=&quot;#fdfddf&quot;&gt;&lt;a href=&quot;(?P&lt;download&gt;.*?)&quot;&gt;&#x27;</span>, re.S)</span><br><span class="line">result1 = obj1.finditer(resp.text)</span><br><span class="line">sub_href_lst = []</span><br><span class="line"><span class="keyword">for</span> it <span class="keyword">in</span> result1:</span><br><span class="line">    ul = it.group(<span class="string">&#x27;ul&#x27;</span>)</span><br><span class="line">    <span class="comment"># print(ul)</span></span><br><span class="line">    <span class="comment">#     提取子页面链接</span></span><br><span class="line">    result2 = obj2.finditer(ul)</span><br><span class="line">    <span class="keyword">for</span> itt <span class="keyword">in</span> result2:</span><br><span class="line">        <span class="comment"># print(itt.group(&#x27;href&#x27;))</span></span><br><span class="line">        <span class="comment"># 拼接子页面url:域名+子页面地址</span></span><br><span class="line">        sub_href = domain + itt.group(<span class="string">&#x27;href&#x27;</span>).strip(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">        <span class="comment"># 子页面列表存储</span></span><br><span class="line">        sub_href_lst.append(sub_href)</span><br><span class="line">        <span class="comment"># print(sub_href)</span></span><br><span class="line"><span class="comment"># 提取子页面内容</span></span><br><span class="line"><span class="keyword">for</span> href <span class="keyword">in</span> sub_href_lst:</span><br><span class="line">    sub_resp = requests.get(href, verify=<span class="literal">False</span>)</span><br><span class="line">    sub_resp.encoding = <span class="string">&#x27;gb2312&#x27;</span></span><br><span class="line">    <span class="comment"># print(sub_resp.text)</span></span><br><span class="line">    result3 = obj3.search(sub_resp.text)</span><br><span class="line">    <span class="built_in">print</span>(result3.group(<span class="string">&quot;movie&quot;</span>).strip())</span><br><span class="line">    <span class="built_in">print</span>(result3.group(<span class="string">&quot;download&quot;</span>))</span><br><span class="line">    <span class="comment"># break  # 测试用</span></span><br></pre></td></tr></table></figure>
<h3 id="2-5-bs4解析-HTML语法">2.5 bs4解析_HTML语法</h3>
<p>HTML是超文本标记语言，是我们编写网页的最基本也是最核心的一种语言，其语法规则就是用不同的标签对网页上的内容进行标记，从而使网页显示出不同的效果</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><br><span class="line">    i love you</span><br><span class="line"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span>&gt;</span></span><br><span class="line">    i don&#x27;t love you</span><br><span class="line"><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>h1:标签<br>
align:属性<br>
center:属性值–&gt;<br>
==&lt;标签 属性=“属性值”&gt;被标记内容&lt;/标签&gt;==</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;xxx.jpg&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://www.baidu.com&quot;</span>&gt;</span>周杰伦 <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>自封闭标签⬆️</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;h1&quot;</span>&gt;</span>周杰伦<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;h1&quot;</span>&gt;</span>林俊杰<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;3&quot;</span> <span class="attr">class</span>=<span class="string">&quot;h1&quot;</span>&gt;</span>马化腾<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;4&quot;</span> <span class="attr">class</span>=<span class="string">&quot;h4&quot;</span>&gt;</span>唐老鸭<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;5&quot;</span> <span class="attr">class</span>=<span class="string">&quot;h5&quot;</span>&gt;</span>刘征昊<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>通过标签名称/特征来拿到数据</p>
<p>div -&gt; id:3 =&gt;马化腾</p>
<p>div -&gt; class:h4 =&gt;唐老鸭</p>
<h3 id="2-6-bs4解析-新发地">2.6 bs4解析_新发地</h3>
<p>安装：pip install bs4 -i</p>
<p>1.拿到页面源代码</p>
<p>2.使用bs4解析源代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://www.xinfadi.com.cn/index.html&quot;</span></span><br><span class="line">resp = requests.get(url)</span><br><span class="line"><span class="comment"># print(resp.text)</span></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;新发地.csv&quot;</span>, <span class="string">&quot;w&quot;</span>)</span><br><span class="line">csv_writer = csv.writer(f)</span><br><span class="line"><span class="comment"># 解析数据</span></span><br><span class="line"><span class="comment"># 1.把页面源代码交给BeaytifulSoup进行处理，生成bs4对象</span></span><br><span class="line">page = BeautifulSoup(resp.text, <span class="string">&quot;html.parser&quot;</span>)  <span class="comment"># 指定html解析器</span></span><br><span class="line"><span class="comment"># 2.从bs对象中查找数据</span></span><br><span class="line"><span class="comment"># find(标签, 属性=值)</span></span><br><span class="line"><span class="comment"># find_all</span></span><br><span class="line"><span class="comment"># table = page.find(&quot;table&quot;, class_=&quot;hq_table&quot;)  # class是python关键字，加下划线区分</span></span><br><span class="line">table = page.find(<span class="string">&quot;table&quot;</span>, attrs=&#123;<span class="string">&quot;border&quot;</span>: <span class="string">&quot;0&quot;</span>, <span class="string">&quot;cellspacing&quot;</span>: <span class="string">&quot;0&quot;</span>, <span class="string">&quot;cellpadding&quot;</span>: <span class="string">&quot;0&quot;</span>&#125;)  <span class="comment"># 使用字典避免上面的情况</span></span><br><span class="line"><span class="built_in">print</span>(table)</span><br><span class="line">trs = table.find_all(<span class="string">&quot;tr&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> tr <span class="keyword">in</span> trs:</span><br><span class="line">    ths = tr.find_all(<span class="string">&quot;th&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(ths)):</span><br><span class="line">        <span class="comment"># print(th.text) 获取被标签的内容</span></span><br><span class="line">        ths[i] = ths[i].text</span><br><span class="line">    csv_writer.writerow(ths)</span><br></pre></td></tr></table></figure>
<h3 id="2-7-bs4解析-抓取优美图库">2.7 bs4解析_抓取优美图库</h3>
<p>1.拿到主页面的源代码，然后提取子页面的链接地址，href</p>
<p>2.通过href拿到子页面的内容，从子页面中找到图片的下载地址 img-&gt;src</p>
<p>3.下载图片(二进制文件直接写入)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url = <span class="string">&quot;https://www.umei.cc/bizhitupian/weimeibizhi/&quot;</span></span><br><span class="line"></span><br><span class="line">resp = requests.get(url)</span><br><span class="line">resp.encoding = <span class="string">&quot;utf-8&quot;</span></span><br><span class="line"><span class="comment"># print(resp.text)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 把源代码交给bs</span></span><br><span class="line">main_page = BeautifulSoup(resp.text, <span class="string">&quot;html.parser&quot;</span>)</span><br><span class="line">a_lst = main_page.find(<span class="string">&quot;div&quot;</span>, attrs=&#123;<span class="string">&quot;class&quot;</span>: <span class="string">&quot;swiper-box&quot;</span>&#125;).find_all(<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="comment"># print(a_lst)</span></span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> a_lst:</span><br><span class="line">    <span class="comment"># .get()可以直接拿到属性的值</span></span><br><span class="line">    href = <span class="string">&quot;https://www.umei.cc&quot;</span>+a.get(<span class="string">&#x27;href&#x27;</span>)</span><br><span class="line">    <span class="comment"># 拿到子页面的源代码</span></span><br><span class="line">    sub_page_resp = requests.get(href)</span><br><span class="line">    sub_page_resp.encoding = <span class="string">&quot;utf-8&quot;</span></span><br><span class="line">    sub_page_text = sub_page_resp.text</span><br><span class="line">    <span class="comment"># 从子页面中拿到图片的下载地址</span></span><br><span class="line">    sub_page = BeautifulSoup(sub_page_text, <span class="string">&quot;html.parser&quot;</span>)</span><br><span class="line">    section = sub_page.find(<span class="string">&quot;section&quot;</span>, attrs=&#123;<span class="string">&quot;class&quot;</span>: <span class="string">&quot;img-content&quot;</span>&#125;)</span><br><span class="line">    img = section.find(<span class="string">&quot;img&quot;</span>)</span><br><span class="line">    src = img.get(<span class="string">&quot;src&quot;</span>)</span><br><span class="line">    <span class="comment"># 下载图片</span></span><br><span class="line">    img_resp = requests.get(src)</span><br><span class="line">    <span class="comment"># img_resp.content  #拿到图片字节</span></span><br><span class="line">    img_name = src.split(<span class="string">&#x27;/&#x27;</span>)[-<span class="number">1</span>]  <span class="comment"># 拿到url中最后一个/后内容作为名字</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;2.7img/&quot;</span>+img_name, mode=<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(img_resp.content)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;over!&quot;</span>, img_name)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;all over!&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<!--注：文件目录为避免PyCharm构建索引耗时，可将其标记为“排除”-->
<h3 id="2-8-xpath解析">2.8 xpath解析</h3>
<h4 id="2-8-1-xpath解析入门1">2.8.1 xpath解析入门1</h4>
<p><strong>xpath</strong> 是<strong>XML</strong>文档中搜索内容的一种语言</p>
<p>html是xml的一个<strong>子集</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">book</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>1<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>野花遍地香<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">price</span>&gt;</span>1.23<span class="tag">&lt;/<span class="name">price</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">author</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nick</span>&gt;</span>周大强<span class="tag">&lt;/<span class="name">nick</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nick</span>&gt;</span>周芷若<span class="tag">&lt;/<span class="name">nick</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">book</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><xxx>称作节点</xxx></p>
<p>book与id、name等互为父子节点；id name为兄弟节点</p>
<p>访问规则：/book/price（类似文件路径）		也可通过属性</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_34415923/article/details/93476967?spm=1001.2101.3001.6661.1&amp;utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-93476967-blog-113977784.pc_relevant_multi_platform_featuressortv2dupreplace&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-93476967-blog-113977784.pc_relevant_multi_platform_featuressortv2dupreplace&amp;utm_relevant_index=1">安装lxml模块链接</a></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># xpath解析</span></span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line">xml = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;book&gt;</span></span><br><span class="line"><span class="string">    &lt;id&gt;1&lt;/id&gt;</span></span><br><span class="line"><span class="string">    &lt;name&gt;野花遍地香&lt;/name&gt;</span></span><br><span class="line"><span class="string">    &lt;price&gt;1.23&lt;/price&gt;</span></span><br><span class="line"><span class="string">    &lt;nick&gt;臭豆腐&lt;/nick&gt;</span></span><br><span class="line"><span class="string">    &lt;author&gt;</span></span><br><span class="line"><span class="string">        &lt;nick id=&quot;10086&quot;&gt;周大强&lt;/nick&gt;</span></span><br><span class="line"><span class="string">        &lt;nick id=&quot;10010&quot;&gt;周芷若&lt;/nick&gt;</span></span><br><span class="line"><span class="string">        &lt;nick class=&quot;jay&quot;&gt;周杰伦&lt;/nick&gt;</span></span><br><span class="line"><span class="string">        &lt;nick class=&quot;jolin&quot;&gt;蔡依林&lt;/nick&gt;</span></span><br><span class="line"><span class="string">        &lt;div&gt;</span></span><br><span class="line"><span class="string">            &lt;nick&gt;热热热热1&lt;/nick&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;span&gt;</span></span><br><span class="line"><span class="string">            &lt;nick&gt;热热热热2&lt;/nick&gt;</span></span><br><span class="line"><span class="string">        &lt;/span&gt;</span></span><br><span class="line"><span class="string">    &lt;/author&gt;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    &lt;partner&gt;</span></span><br><span class="line"><span class="string">        &lt;nick id=&quot;ppc&quot;&gt;胖胖沉&lt;/nick&gt;</span></span><br><span class="line"><span class="string">        &lt;nick id=&quot;ppbc&quot;&gt;胖胖不沉&lt;/nick&gt;</span></span><br><span class="line"><span class="string">    &lt;/partner&gt;</span></span><br><span class="line"><span class="string">&lt;/book&gt;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">tree = etree.XML(xml)</span><br><span class="line"><span class="comment"># result = tree.xpath(&quot;/book&quot;) 拿到节点</span></span><br><span class="line"><span class="comment"># result = tree.xpath(&quot;/book/name/text()&quot;)  # /text()拿到节点内文本</span></span><br><span class="line"><span class="comment"># result = tree.xpath(&quot;/book/author/nick/text()&quot;)  # 只会找同层级nick</span></span><br><span class="line"><span class="comment"># result = tree.xpath(&quot;/book/author//nick/text()&quot;)  # 找不同层级nick（包含后代）</span></span><br><span class="line"><span class="comment"># result = tree.xpath(&quot;/book/author/*/nick/text()&quot;)  # *为任意节点，通配符</span></span><br><span class="line">result = tree.xpath(<span class="string">&quot;/book//nick/text()&quot;</span>)  <span class="comment"># *为任意节点，通配符</span></span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure>
<h4 id="2-8-1-xpath解析入门2">2.8.1 xpath解析入门2</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line">tree = etree.parse(<span class="string">&quot;2.8.2xpath.html&quot;</span>)</span><br><span class="line"><span class="comment"># result = tree.xpath(&#x27;/html&#x27;)</span></span><br><span class="line"><span class="comment"># result = tree.xpath(&#x27;/html/body/ul/li/a/text()&#x27;)</span></span><br><span class="line"><span class="comment"># result = tree.xpath(&#x27;/html/body/ul/li[1]/a/text()&#x27;)  # xpath下标从1开始</span></span><br><span class="line"><span class="comment"># result = tree.xpath(&quot;/html/body/ol/li/a[@href=&#x27;dapao&#x27;]/text()&quot;)  # [@xxx=&quot;yyy]指定属性及值</span></span><br><span class="line">ol_li_lst = tree.xpath(<span class="string">&quot;/html/body/ol/li&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> li <span class="keyword">in</span> ol_li_lst:</span><br><span class="line">    <span class="comment"># 从每个li中提取文字</span></span><br><span class="line">    result = li.xpath(<span class="string">&quot;./a/text()&quot;</span>)  <span class="comment"># 子节点继续查找（相对查找）</span></span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line">    result2 = li.xpath(<span class="string">&quot;./a/@href&quot;</span>)  <span class="comment"># /@xxx相对查找属性值</span></span><br><span class="line">    <span class="built_in">print</span>(result2)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(tree.xpath(<span class="string">&quot;/html/body/ul/li/a/@href&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(tree.xpath(<span class="string">&quot;/html/body/div[1]/text()&quot;</span>))  <span class="comment"># 使用检查定位到代码段，右键复制代码段xpath</span></span><br></pre></td></tr></table></figure>
<h3 id="2-9-xpath解析实例-干猪八戒">2.9 xpath解析实例_干猪八戒</h3>
<p><strong>步骤</strong>：</p>
<ol>
<li>拿到页面源代码</li>
<li>提取和解析</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;https://huhehaote.zbj.com/search/service/?kw=saas&amp;r=1&quot;</span></span><br><span class="line">resp = requests.get(url)</span><br><span class="line"><span class="comment"># print(resp.text)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析</span></span><br><span class="line">html = etree.HTML(resp.text)</span><br><span class="line"><span class="comment">#  拿到每一个服务商的div</span></span><br><span class="line">divs = html.xpath(<span class="string">&#x27;/html/body/div[@id=&quot;__nuxt&quot;]/div/div/div[3]/div/div[3]/div[4]/div[1]/div&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> div <span class="keyword">in</span> divs:</span><br><span class="line">    <span class="comment"># print(div)</span></span><br><span class="line">    price = div.xpath(<span class="string">&quot;./div[3]/div[1]/span/text()&quot;</span>)[-<span class="number">1</span>].strip(<span class="string">&quot;￥&quot;</span>)</span><br><span class="line">    title = div.xpath(<span class="string">&quot;./div[3]/a/text()&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">    company_name = div.xpath(<span class="string">&quot;./a/div[2]/div[1]/div/text()&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(price)</span><br><span class="line">    <span class="built_in">print</span>(title)</span><br><span class="line">    <span class="built_in">print</span>(company_name)</span><br></pre></td></tr></table></figure>
<h2 id="第3章-requests模块进阶">第3章 requests模块进阶</h2>
<h3 id="3-1-requests进阶概述">3.1 requests进阶概述</h3>
<p>headers是HTTP协议中的请求头，一般存放一些和请求内容无关的数据，有时也会存放一些安全验证信息，比如常见的：User-Agent，token，cookie等</p>
<p>通过 requests发送的请求，我们可以把请求头信息放在headers中，也可以单独进行存放，最终由requests自动帮我们拼接完成完整的http请求头。</p>
<p><strong>本章内容</strong>：</p>
<ol>
<li>模拟浏览器登录-&gt;处理cookie</li>
<li>防盗链处理-&gt;抓取梨视频数据</li>
<li>代理-&gt;防止被封ip</li>
<li>综合训练：抓取网易云评论信息</li>
</ol>
<h3 id="3-2-模拟用户登录-处理cookie">3.2 模拟用户登录_处理cookie</h3>
<p>登陆 -&gt; 得到cookie，必须带着cookie去请求书架url -&gt; 书架上得内容</p>
<p>**解决方案：**可以使用session(会话)进行请求 -&gt; session可以认为是一连串的请求，在这个过程中cookie不会丢失</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="comment"># 会话</span></span><br><span class="line">session = requests.session()</span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;loginName&quot;</span>: <span class="string">&quot;19997617865&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: <span class="string">&quot;thebest1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 1.登陆</span></span><br><span class="line">url = <span class="string">&quot;https://passport.17k.com/ck/user/login&quot;</span></span><br><span class="line">resp1 = session.post(url, data=data)</span><br><span class="line"><span class="comment"># print(resp.text)</span></span><br><span class="line"><span class="comment"># print(resp.cookies)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.拿书架上数据</span></span><br><span class="line"><span class="comment"># 刚才session中含有cookie</span></span><br><span class="line">resp2 = session.get(<span class="string">&quot;https://user.17k.com/ck/author/shelf?page=1&amp;appKey=2406394919&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(resp2.json())</span><br></pre></td></tr></table></figure>
<h3 id="3-3-防盗链处理-抓取梨视频">3.3 防盗链处理_抓取梨视频</h3>
<p>无法打开的：<a target="_blank" rel="noopener" href="https://video.pearvideo.com/mp4/adshort/20210122/">https://video.pearvideo.com/mp4/adshort/20210122/</a> ==1660915088310==-15583450_adpkg-ad_hd.mp4</p>
<p>可以打开的：<a target="_blank" rel="noopener" href="https://video.pearvideo.com/mp4/adshort/20210122/">https://video.pearvideo.com/mp4/adshort/20210122/</a> ==cont-1717518==-15583450_adpkg-ad_hd.mp4</p>
<p>1660915088310 -&gt; cont-1717518进行了替换</p>
<p>1.拿到cont ID</p>
<p>2.拿到videostatus返回的json -&gt; srcURL</p>
<p>3.srcURL内容进行修改</p>
<p>4.下载视频</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;https://www.pearvideo.com/video_1717518&quot;</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.0.0 Safari/537.36&quot;</span>,</span><br><span class="line">    <span class="comment"># 防盗链:溯源，当前本次请求的上一级是谁</span></span><br><span class="line">    <span class="string">&quot;Referer&quot;</span>: url</span><br><span class="line">&#125;</span><br><span class="line">cont_id = url.split(<span class="string">&quot;_&quot;</span>)[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">video_status = <span class="string">f&quot;https://www.pearvideo.com/videoStatus.jsp?contId=<span class="subst">&#123;cont_id&#125;</span>&amp;mrd=0.24171138432822437&quot;</span></span><br><span class="line">resp = requests.get(video_status, headers=headers)</span><br><span class="line"><span class="comment"># print(resp.text)  # 该文章已经下线！-&gt; 被反爬 -&gt; headers -&gt; 仍然不行</span></span><br><span class="line">src_url = resp.json()[<span class="string">&#x27;videoInfo&#x27;</span>][<span class="string">&#x27;videos&#x27;</span>][<span class="string">&#x27;srcUrl&#x27;</span>]</span><br><span class="line">system_time = resp.json()[<span class="string">&#x27;systemTime&#x27;</span>]</span><br><span class="line"></span><br><span class="line">src_url = src_url.replace(system_time, <span class="string">f&quot;cont-<span class="subst">&#123;cont_id&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(src_url)  <span class="comment"># https://video.pearvideo.com/mp4/adshort/20210122/cont-1717518-15583450_adpkg-ad_hd.mp4</span></span><br><span class="line"><span class="comment"># 下载视频</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;vedio.mp4&quot;</span>, mode=<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(requests.get(src_url).content)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<h3 id="3-4-代理">3.4 代理</h3>
<p>​         <strong>原理</strong>：通过第三方的一个机器去发送请求</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="comment"># 218.60.8.83:3129</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&quot;https&quot;</span>: <span class="string">&quot;https://218.60.8.83:3129&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">resp = requests.get(<span class="string">&quot;https://www.baidu.com&quot;</span>, proxies=proxies)</span><br><span class="line">resp.encoding = <span class="string">&quot;utf-8&quot;</span></span><br><span class="line"><span class="built_in">print</span>(resp.text)</span><br></pre></td></tr></table></figure>
<h3 id="3-5-综合训练-抓取网易云音乐热评">3.5 综合训练_抓取网易云音乐热评</h3>
<p>1.找到未加密的参数</p>
<p>2.想办法把参数进行加密(参考网易逻辑), params -&gt; encText / encSecKey（加密函数：window.arsea（参数, xxx…））</p>
<p>3.请求到网易，拿到评论信息</p>
<p><strong>AES加密</strong>：需要安装pycrypto -&gt; pip install pycryptodome</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;https://music.163.com/weapi/comment/resource/comments/get?csrf_token=&quot;</span></span><br><span class="line"><span class="comment"># 请求方式：post</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;csrf_token&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;cursor&quot;</span>: <span class="string">&quot;-1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;offset&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;orderType&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;pageNo&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;pageSize&quot;</span>: <span class="string">&quot;20&quot;</span>,</span><br><span class="line">    <span class="string">&quot;rid&quot;</span>: <span class="string">&quot;R_SO_4_1327162577&quot;</span>,</span><br><span class="line">    <span class="string">&quot;threadId&quot;</span>: <span class="string">&quot;R_SO_4_1327162577&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 服务于d</span></span><br><span class="line">e = <span class="string">&quot;010001&quot;</span></span><br><span class="line">f = <span class="string">&quot;00e0b509f6259df8642dbc35662901477df22677ec152b5ff68ace615bb7b725152b3ab17a876aea8a5aa76d2e417629ec4ee341f56135fccf695280104e0312ecbda92557c93870114af6c9d05c4f7f0c3685b7a46bee255932575cce10b424d813cfe4875d3e82047b97ddef52741d546b8e289dc6935b3ece0462db0a22b8e7&quot;</span></span><br><span class="line">g = <span class="string">&quot;0CoJUm6Qyw8W8jud&quot;</span></span><br><span class="line">i = <span class="string">&quot;3CHtjTJeAW2lKHMy&quot;</span>  <span class="comment"># 手动固定</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_encSecKey</span>():  <span class="comment"># 基于i而固定的</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;de70557c99d4da3c4dba685119fcd3f6b5bf2f3561c659e53f94ab691d60408944d95d00d882b586429236fc882895060b4aba652eef62071323a4f1bee911d2be7146f21a741dc3b3335c0df1d0949c3c484a845f5b8c97a404c156647157116acd5301bbab9607a08d85d764dc3cb8bf519e97f87a81ee3d64ed3e0c9f0e83&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_params</span>(<span class="params">d</span>):  <span class="comment"># 默认收到字符串</span></span><br><span class="line">    first = enc_params(d, g)</span><br><span class="line">    second = enc_params(first, i)</span><br><span class="line">    <span class="keyword">return</span> second  <span class="comment"># 返回的就是params</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">to_16</span>(<span class="params">d</span>):  <span class="comment"># 转化为16的倍数，为AES算法服务</span></span><br><span class="line">    pad = <span class="number">16</span> - <span class="built_in">len</span>(d) % <span class="number">16</span></span><br><span class="line">    d += <span class="built_in">chr</span>(pad) * pad</span><br><span class="line">    <span class="keyword">return</span> d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enc_params</span>(<span class="params">d, key</span>):  <span class="comment"># 加密过程(还原b)</span></span><br><span class="line">    iv = <span class="string">&quot;0102030405060708&quot;</span></span><br><span class="line">    d = to_16(d)</span><br><span class="line">    aes = AES.new(key=key.encode(<span class="string">&quot;utf-8&quot;</span>), IV=iv.encode(<span class="string">&quot;utf-8&quot;</span>), mode=AES.MODE_CBC)  <span class="comment"># 创造加密器</span></span><br><span class="line">    bs = aes.encrypt(d.encode(<span class="string">&quot;utf-8&quot;</span>))  <span class="comment"># 加密,加密的内容长度必须是16倍数,</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(b64encode(bs), <span class="string">&quot;utf-8&quot;</span>)  <span class="comment"># 转化成字符串</span></span><br></pre></td></tr></table></figure>
<p>加密源代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">function</span> <span class="title function_">a</span>(<span class="params">a</span>) &#123;  <span class="comment">//返回随机的16位字符串</span></span><br><span class="line">         <span class="keyword">var</span> d, e, b = <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span>, c = <span class="string">&quot;&quot;</span>;</span><br><span class="line">         <span class="keyword">for</span> (d = <span class="number">0</span>; a &gt; d; d += <span class="number">1</span>)  <span class="comment">////循环16次</span></span><br><span class="line">             e = <span class="title class_">Math</span>.<span class="title function_">random</span>() * b.<span class="property">length</span>,   <span class="comment">//随机数</span></span><br><span class="line">             e = <span class="title class_">Math</span>.<span class="title function_">floor</span>(e),   <span class="comment">//取整</span></span><br><span class="line">             c += b.<span class="title function_">charAt</span>(e);   <span class="comment">//取b字符串中的xxx位置</span></span><br><span class="line">         <span class="keyword">return</span> c</span><br><span class="line"> &#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">b</span>(<span class="params">a, b</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> c = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(b)   <span class="comment">////加密的密钥</span></span><br><span class="line">  , d = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(<span class="string">&quot;0102030405060708&quot;</span>)</span><br><span class="line">  , e = <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>.<span class="title function_">parse</span>(a)   <span class="comment">//数据</span></span><br><span class="line">  , f = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">encrypt</span>(e, c, &#123;</span><br><span class="line">    <span class="attr">iv</span>: d,   <span class="comment">//AES加密：偏移量</span></span><br><span class="line">    <span class="attr">mode</span>: <span class="title class_">CryptoJS</span>.<span class="property">mode</span>.<span class="property">CBC</span>   <span class="comment">//模式：cbc</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> f.<span class="title function_">toString</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">c</span>(<span class="params">a, b, c</span>) &#123;   <span class="comment">//c不产生随机数</span></span><br><span class="line">  <span class="keyword">var</span> d, e;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">setMaxDigits</span>(<span class="number">131</span>),</span><br><span class="line">    d = <span class="keyword">new</span> <span class="title class_">RSAKeyPair</span>(b,<span class="string">&quot;&quot;</span>,c),</span><br><span class="line">    e = <span class="title function_">encryptedString</span>(d, a)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d</span>(<span class="params">d, e, f, g</span>) &#123;  <span class="comment">//d:数据data  e:执行后为010001 f/g:固定值如上</span></span><br><span class="line">  <span class="keyword">var</span> h = &#123;&#125;</span><br><span class="line">  , i = <span class="title function_">a</span>(<span class="number">16</span>);   <span class="comment">//是一个16位随机字符串</span></span><br><span class="line">  <span class="keyword">return</span> h.<span class="property">encText</span> = <span class="title function_">b</span>(d, g),</span><br><span class="line">    h.<span class="property">encText</span> = <span class="title function_">b</span>(h.<span class="property">encText</span>, i),   <span class="comment">//返回的params, enctext通过b进行了两次加密</span></span><br><span class="line">    h.<span class="property">encSecKey</span> = <span class="title function_">c</span>(i, e, f),   <span class="comment">//得到encSecKey,且只与i有关</span></span><br><span class="line">    h    <span class="comment">//逗号语句,先执行前几个,然后return最后一个</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加密后请求：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">resp = requests.post(url, data=&#123;</span><br><span class="line">    <span class="string">&quot;params&quot;</span>: get_params(json.dumps(data)),</span><br><span class="line">    <span class="string">&quot;encSecKey&quot;</span>: get_encSecKey(),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>评论数据提取及输出：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;comment.csv&quot;</span>, mode=<span class="string">&quot;w&quot;</span>)</span><br><span class="line">f_hot = <span class="built_in">open</span>(<span class="string">&quot;comment_hot.csv&quot;</span>, mode=<span class="string">&quot;w&quot;</span>)</span><br><span class="line">csv_writer = csv.writer(f)</span><br><span class="line">csv_writer_hot = csv.writer(f_hot)</span><br><span class="line"><span class="comment"># 提取最新评论</span></span><br><span class="line">users = resp.json()[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;comments&quot;</span>]</span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> users:</span><br><span class="line">    nickname = user[<span class="string">&quot;user&quot;</span>][<span class="string">&quot;nickname&quot;</span>]</span><br><span class="line">    content = user[<span class="string">&quot;content&quot;</span>]</span><br><span class="line">    timeStr = user[<span class="string">&quot;timeStr&quot;</span>]</span><br><span class="line">    comment = [nickname, content, timeStr]</span><br><span class="line">    csv_writer.writerow(comment)</span><br><span class="line"><span class="comment"># 提取热门评论</span></span><br><span class="line">users_hot = resp.json()[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;hotComments&quot;</span>]</span><br><span class="line"><span class="keyword">for</span> user_hot <span class="keyword">in</span> users_hot:</span><br><span class="line">    nickname = user_hot[<span class="string">&quot;user&quot;</span>][<span class="string">&quot;nickname&quot;</span>]</span><br><span class="line">    content = user_hot[<span class="string">&quot;content&quot;</span>]</span><br><span class="line">    timeStr = user_hot[<span class="string">&quot;timeStr&quot;</span>]</span><br><span class="line">    comment_hot = [nickname, content, timeStr]</span><br><span class="line">    csv_writer_hot.writerow(comment_hot)</span><br></pre></td></tr></table></figure>
<h2 id="第4章-多线程与多进程">第4章 多线程与多进程</h2>
<h3 id="4-1-线程与进程">4.1 线程与进程</h3>
<p>进程：资源单位,每个进程至少含有一个线程<br>
线程：执行单位<br>
（启动每一个程序都会默认有一个主线程）</p>
<h3 id="4-2-多线程">4.2 多线程</h3>
<h4 id="4-2-1-单线程">4.2.1 单线程</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;func&quot;</span>, i)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    func()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;main&quot;</span>, i)</span><br></pre></td></tr></table></figure>
<h4 id="4-2-2-多线程1">4.2.2 多线程1</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;func&quot;</span>, i)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    t = Thread(target=func, args=(<span class="string">&quot;一号&quot;</span>，))  <span class="comment"># 创建线程并安排线程任务</span></span><br><span class="line">    t.start()  <span class="comment"># 多线程状态为可以开始(不意味即刻开始，具体时间由cpu决定)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;main&quot;</span>, i)</span><br></pre></td></tr></table></figure>
<h4 id="4-2-3-多线程2">4.2.3 多线程2</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">myThread</span>(<span class="title class_ inherited__">Thread</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):  <span class="comment"># 固定的 -&gt; 当线程被执行时启动</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;子线程&quot;</span>, i)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    t = myThread()</span><br><span class="line">    t.start()  <span class="comment"># 开启线程</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;主线程&quot;</span>, i)</span><br></pre></td></tr></table></figure>
<h3 id="4-4-线程池和进程池">4.4 线程池和进程池</h3>
<p><strong>线程池</strong>:一次性开辟一些线程，用户直接给线程池提交任务，线程任务的调度交给线程池来完成</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor, ProcessPoolExecutor</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fn</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">        <span class="built_in">print</span>(name, i)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 创建线程池</span></span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(<span class="number">50</span>) <span class="keyword">as</span> t:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">            t.submit(fn, name=<span class="string">f&quot;线程<span class="subst">&#123;i&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment"># 等待线程池中的任务全部执行完毕，才继续执行</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;over&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="4-5-线程池和进程池实例-新发地菜价">4.5 线程池和进程池实例_新发地菜价</h3>
<p>1.如何提取单个页面的数据</p>
<p>2.上线程池，多个页面同时抓取</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://www.xinfadi.com.cn/getPriceData.html&quot;</span></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;菜价.csv&quot;</span>, <span class="string">&quot;w&quot;</span>)</span><br><span class="line">csvWriter = csv.writer(f)</span><br><span class="line">firstLine = [<span class="string">&#x27;prodName&#x27;</span>, <span class="string">&#x27;lowPrice&#x27;</span>, <span class="string">&#x27;highPrice&#x27;</span>, <span class="string">&#x27;avgPrice&#x27;</span>, <span class="string">&#x27;unitInfo&#x27;</span>, <span class="string">&#x27;place&#x27;</span>, <span class="string">&#x27;pubDate&#x27;</span>]</span><br><span class="line">csvWriter.writerow(firstLine)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_one_page</span>(<span class="params">current</span>):</span><br><span class="line">    <span class="comment"># 拿到页面源代码</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;current&quot;</span>: <span class="built_in">str</span>(current)  <span class="comment"># 传参:改变页数</span></span><br><span class="line">    &#125;</span><br><span class="line">    resp = requests.post(url, data=data)</span><br><span class="line">    lsts = resp.json()[<span class="string">&#x27;list&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> dic <span class="keyword">in</span> lsts:  <span class="comment"># 获取json并选择有效数据</span></span><br><span class="line">        lst = [dic[<span class="string">&#x27;prodName&#x27;</span>], dic[<span class="string">&#x27;lowPrice&#x27;</span>], dic[<span class="string">&#x27;highPrice&#x27;</span>], dic[<span class="string">&#x27;avgPrice&#x27;</span>],</span><br><span class="line">               dic[<span class="string">&#x27;unitInfo&#x27;</span>], dic[<span class="string">&#x27;place&#x27;</span>], dic[<span class="string">&#x27;pubDate&#x27;</span>].split()[<span class="number">0</span>]]</span><br><span class="line">        csvWriter.writerow(lst)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># for i in range(1,14870):  # 效率低下</span></span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(<span class="number">50</span>) <span class="keyword">as</span> t:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">201</span>):  <span class="comment"># 开启线程池(50),爬取前200页</span></span><br><span class="line">            t.submit(download_one_page, i)  <span class="comment"># 把任务交给线程池</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;over!&quot;</span>)</span><br><span class="line">    f.close()</span><br></pre></td></tr></table></figure>
<h3 id="4-6-协程">4.6 协程</h3>
<p><strong>协程</strong>：当程序遇到了IO操作，可以选择性的切换到其他任务上。</p>
<p>微观上一个任务一个任务的切换，切换条件为IO操作；宏观上，可以观察到多个任务同时进行。（==多任务异步操==作）</p>
<p>条件：单线程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;我爱&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">3</span>) </span><br><span class="line">    <span class="comment"># 让当前线程处于阻塞状态，cpu不工作</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;我真的爱&quot;</span>)</span><br><span class="line"><span class="comment"># input()也处于阻塞状态</span></span><br><span class="line"><span class="comment"># requests.get(b站) 网络请求返回数据之前，程序也是阻塞状态</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    func()</span><br></pre></td></tr></table></figure>
<p>py编写协程的程序</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func1</span>():</span><br><span class="line">  	<span class="built_in">print</span>(<span class="string">&quot;hello!&quot;</span>)</span><br><span class="line">  	<span class="comment"># time.sleep(2)  # 当程序出现了同步操作时，异步就中断了</span></span><br><span class="line">  	<span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)  <span class="comment"># 异步操作实现方式</span></span><br><span class="line">  	<span class="built_in">print</span>(<span class="string">&quot;byebye&quot;</span>)</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func2</span>():</span><br><span class="line">     <span class="built_in">print</span>(<span class="string">&quot;我叫lzh&quot;</span>)</span><br><span class="line">     <span class="comment"># time.sleep(3)</span></span><br><span class="line">     <span class="keyword">await</span> asyncio.sleep(<span class="number">3</span>)</span><br><span class="line">     <span class="built_in">print</span>(<span class="string">&quot;你好啊&quot;</span>)</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func3</span>():</span><br><span class="line">  	<span class="built_in">print</span>(<span class="string">&quot;我叫lst&quot;</span>)</span><br><span class="line">    <span class="comment"># time.sleep(3)</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">4</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;你好美啊&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># g = func1()  # 此时函数是异步协程函数，此时函数执行得到一个协程对象</span></span><br><span class="line">    <span class="comment"># asyncio.run(g)  # 协程程序运行需要asynio模块支持</span></span><br><span class="line">    f1 = func1()</span><br><span class="line">    f2 = func2()</span><br><span class="line">    f3 = func3()</span><br><span class="line">    tasks = [f1, f2, f3]</span><br><span class="line">    <span class="comment">#  一次性启动多个任务（协程）</span></span><br><span class="line">    t1 = time.time()</span><br><span class="line">    asyncio.run(asyncio.wait(tasks))</span><br><span class="line">    t2 = time.time()</span><br><span class="line">    <span class="built_in">print</span>(t2 - t1)</span><br></pre></td></tr></table></figure>
<p>出现同步操作时的异步操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func1</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hello!&quot;</span>)</span><br><span class="line">    <span class="comment"># time.sleep(2)  # 当程序出现了同步操作时，异步就中断了</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)  <span class="comment"># 异步操作实现方式</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;byebye&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func2</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;我叫lzh&quot;</span>)</span><br><span class="line">    <span class="comment"># time.sleep(3)</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;你好啊&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func3</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;我叫lst&quot;</span>)</span><br><span class="line">    <span class="comment"># time.sleep(3)</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">4</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;你好美啊&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 写法1</span></span><br><span class="line">    <span class="comment"># f1 = func1()  一般await挂起操作在协程对象前面</span></span><br><span class="line">    <span class="comment"># await f1</span></span><br><span class="line">    <span class="comment"># 写法2(推荐)</span></span><br><span class="line">    tasks = [asyncio.create_task(func1()), asyncio.create_task(func2()), asyncio.create_task(func3())]</span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    t1 = time.time()</span><br><span class="line">    asyncio.run(main())</span><br><span class="line">    t2 = time.time()</span><br><span class="line">    <span class="built_in">print</span>(t2 - t1)</span><br></pre></td></tr></table></figure>
<p>在爬虫领域的应用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;准备开始下载&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)  <span class="comment"># 网络请求:requests.get()</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;下载完成&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    urls = [</span><br><span class="line">        <span class="string">&quot;http://www.baidu.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;http://www.google.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;http://www.163.com&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="comment"># 准备异步协程对象列表</span></span><br><span class="line">    tasks = []</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">        tasks.append(asyncio.create_task(download(url)))</span><br><span class="line">    <span class="comment"># tasks = [asyncio.create_task(download(url)) for url in urls]</span></span><br><span class="line">    <span class="comment"># 一次性所有任务都执行</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    b_id = <span class="string">&quot;4306063500&quot;</span></span><br><span class="line">    url = <span class="string">&quot;www&quot;</span></span><br><span class="line">    asyncio.run(download, url)</span><br></pre></td></tr></table></figure>
<h3 id="4-7-异步http请求-aiohttp模块讲解">4.7 异步http请求_aiohttp模块讲解</h3>
<p>requests.get()同步的代码 -&gt; 异步操作aiohttp</p>
<p>安装：pip install aiohttp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"></span><br><span class="line">urls = [</span><br><span class="line">    <span class="string">&quot;http://kr.shanghai-jiuxin.com/file/2022/0812/59a67a6e9e44225285d4a545cd2acb0e.jpg&quot;</span>,</span><br><span class="line">    <span class="string">&quot;http://kr.shanghai-jiuxin.com/file/2022/0811/94294a360b48155f87bf1e25fe6c247a.jpg&quot;</span>,</span><br><span class="line">    <span class="string">&quot;http://kr.shanghai-jiuxin.com/file/2022/0812/36bc4b3ea78ece2a9ec2d8bf826b36e5.jpg&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">aiodownload</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="comment"># aiohttp.ClientSession() &lt;==&gt; requests</span></span><br><span class="line">    name = <span class="string">&quot;4.7img/&quot;</span>+url.rsplit(<span class="string">&quot;/&quot;</span>)[-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:  <span class="comment"># 发送请求</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(url, verify_ssl=<span class="literal">False</span>) <span class="keyword">as</span> resp:  <span class="comment"># 得到图片</span></span><br><span class="line">            <span class="comment"># resp.text()/resp.json()</span></span><br><span class="line">            <span class="comment"># 保存到文件 扩展:aiofile</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(name, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(<span class="keyword">await</span> resp.content.read())  <span class="comment"># 等价于resp.content</span></span><br><span class="line">    <span class="built_in">print</span>(name, <span class="string">&quot;:over&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    tasks = []</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">        tasks.append(asyncio.create_task(aiodownload(url)))</span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure>
<h3 id="4-8异步爬虫实战-扒光一部小说">4.8异步爬虫实战_扒光一部小说</h3>
<p>1.同步操作:访问getCatalog 拿到所有章节的cid和名称<br>
2.异步操作：访问getChapterContent 下载所有文章和内容<br>
<strong>目录url:</strong> <a target="_blank" rel="noopener" href="https://dushu.baidu.com/api/pc/getCatalog?data=%7B%22book_id%22:%224355370985%22%7D">https://dushu.baidu.com/api/pc/getCatalog?data={“book_id”:“4355370985”}</a><br>
文章内容url: <a target="_blank" rel="noopener" href="https://dushu.baidu.com/api/pc/getChapterContent?data=%7B%22book_id%22:%224355370985%22,%22cid%22:%224355370985%7C1566855961%22,%22need_bookinfo%22:1%7D">https://dushu.baidu.com/api/pc/getChapterContent?data={“book_id”:“4355370985”,“cid”:“4355370985|1566855961”,“need_bookinfo”:1}</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> aiofiles</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">aiodownload</span>(<span class="params">cid, bid, title</span>):</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;book_id&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;bid&#125;</span>&quot;</span>,</span><br><span class="line">        <span class="string">&quot;cid&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;bid&#125;</span>|<span class="subst">&#123;cid&#125;</span>&quot;</span>,</span><br><span class="line">        <span class="string">&quot;need_bookinfo&quot;</span>: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    data = json.dumps(data)</span><br><span class="line">    url_content = <span class="string">f&quot;https://dushu.baidu.com/api/pc/getChapterContent?data=<span class="subst">&#123;data&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(url_content, verify_ssl=<span class="literal">False</span>) <span class="keyword">as</span> resp:</span><br><span class="line">            dic = <span class="keyword">await</span> resp.json()</span><br><span class="line">            name = <span class="string">&quot;4.8novel/&quot;</span>+title+<span class="string">&quot;.txt&quot;</span></span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> aiofiles.<span class="built_in">open</span>(name, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                <span class="keyword">await</span> f.write(dic[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;novel&#x27;</span>][<span class="string">&#x27;content&#x27;</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">getCatalog</span>(<span class="params">u</span>):</span><br><span class="line">    resp = requests.get(u)</span><br><span class="line">    dic = resp.json()</span><br><span class="line">    tasks = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> dic[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;novel&#x27;</span>][<span class="string">&#x27;items&#x27;</span>]:</span><br><span class="line">        title = item[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">        cid = item[<span class="string">&#x27;cid&#x27;</span>]</span><br><span class="line">        <span class="comment"># print(cid, title)</span></span><br><span class="line">        tasks.append(asyncio.create_task(aiodownload(cid, book_id, title)))</span><br><span class="line">        <span class="comment"># 准备异步任务</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    book_id = <span class="string">&quot;4355370985&quot;</span></span><br><span class="line">    url = <span class="string">&#x27;https://dushu.baidu.com/api/pc/getCatalog?data=&#123;&quot;book_id&quot;:&#x27;</span> + book_id + <span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line">    asyncio.run(getCatalog(url))</span><br></pre></td></tr></table></figure>
<h3 id="4-9-综合训练-抓取91视频">4.9 综合训练_抓取91视频</h3>
<h4 id="4-9-1-综合训练-视频网站的工作原理">4.9.1 综合训练_视频网站的工作原理</h4>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">src</span>=<span class="string">&quot;/Users/lzh/Documents/workSpace/pycharm/crawl/第3章/video.mp4&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>一般视频网站是怎么做的？</strong></p>
<ul>
<li>用户上传 -&gt; 转码(把视频做处理，不同清晰度) -&gt; 切片处理(把单个文件拆分)</li>
<li>用户在拉动进度条的时候，直接从某切片开始加载</li>
</ul>
<p><strong>需要一个文件记录: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mn>3</mn><mi>u</mi><msup><mo>+</mo><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi>u</mi><mi>t</mi><mi>f</mi><mo>−</mo><msup><mn>8</mn><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mi>m</mi><mn>3</mn><mi>u</mi><mn>8</mn></mrow><annotation encoding="application/x-tex">m3u + &#x27;utf-8&#x27; = m3u8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8352em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">m</span><span class="mord">3</span><span class="mord mathnormal">u</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin"><span class="mbin">+</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7519em;"></span><span class="mord"><span class="mord">8</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord mathnormal">m</span><span class="mord">3</span><span class="mord mathnormal">u</span><span class="mord">8</span></span></span></span> 文本格式</strong></p>
<ol>
<li>视频播放顺序</li>
<li>视频存放路径</li>
<li>其他信息</li>
</ol>
<p><strong>想要抓取一个视频：</strong></p>
<ol>
<li>找到m3u8(各种手段)</li>
<li>通过m3u8下载ts文件</li>
<li>可以通过各种手段(包括但不限于编程)，把ts文件合并为mp4</li>
</ol>
<p><strong>比较常用和关键的字段:</strong>（其他详见<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/75434f70487f?ivk_sa=1024320u">m3u8关键字段</a>）<br>
　• <strong>EXTM3U</strong>：这个是M3U8文件必须包含的标签，并且必须在文件的第一行，所有的M3U8文件中必须包含这个标签。<br>
　• <strong>EXT-X-VERSION</strong>：M3U8文件的版本，常见的是3（目前最高版本应该是7）。<br>
　• <strong>EXT-X-TARGETDURATION</strong>：该标签指定了*==单个媒体文件持续时间的最大值==*，播放文件列表中的媒体文件在EXTINF标签中定义的持续时间必须小于或者等于该标签指定的持续时间。该标签在播放列表文件中必须出现一次。<br>
　• <strong>EXT-X-MEDIA-SEQUENCE</strong>：M3U8直播是的直播切换序列，当播放打开M3U8时，以这个标签的值作为参考，播放对应的序列号的切片。<br>
　• <strong>EXTINF</strong>：为M3U8列表中每一个分片的duration，如上面例子输出信息中的第一片的duration为2.969秒。在EXTINF标签中，除了duration值，还可以包含可选的描述信息，主要为标注切片信息，使用逗号分隔开。<br>
　• <strong>EXT-X-KEY</strong>:表示怎么对media segments进行解码。其作用范围是下次该tag出现前的所有media URI，格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">    #EXT-X-KEY:&lt;attribute-list&gt;：</span><br></pre></td></tr></table></figure>
<p>​		NONE 或者 AES-128。如果是NONE，则URI以及IV属性必须不存在，如果是AES-128(Advanced EncryptionStandard)，则URI必须存在，IV可以不存在。<br>
​		对于AES-128的情况，keytag和URI属性共同表示了一个key文件，通过URI可以获得这个key，如果没有 IV（Initialization Vector）,则使用序列号作为IV进行编解码，将序列号的高位赋到16个字节的buffer中，左边补0；如果 有IV，则将改值当成16个字节的16进制数。</p>
<h4 id="4-9-2-综合训练-抓取91看剧（简单）">4.9.2 综合训练_抓取91看剧（简单）</h4>
<p><strong>流程：</strong></p>
<ol>
<li>拿到html页面源代码</li>
<li>从源码中提取m3u8的url</li>
<li>下载m3u8，下载视频</li>
<li>合并视频</li>
</ol>
<p><strong>下载m3u8</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="comment"># 用来提取m3u8的url</span></span><br><span class="line">obj = re.<span class="built_in">compile</span>(<span class="string">r&quot;url: &#x27;(?P&lt;url_m3u8&gt;.*?)&#x27;,&quot;</span>, re.S)</span><br><span class="line">url = <span class="string">&quot;http://91kanju2.com/vod-play/62916-3-1.html&quot;</span></span><br><span class="line">resp = requests.get(url)</span><br><span class="line"><span class="comment"># 提取到m3u8地址</span></span><br><span class="line">url_m3u8 = obj.search(resp.text).group(<span class="string">&quot;url_m3u8&quot;</span>)</span><br><span class="line">resp.close()</span><br><span class="line"><span class="comment"># 下载m3u8</span></span><br><span class="line">resp_m3u8 = requests.get(url_m3u8)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;重生之门.m3u8&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(resp_m3u8.content)</span><br><span class="line">resp_m3u8.close()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;over&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>解析m3u8</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">n = <span class="number">1</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;重生之门.m3u8&quot;</span>, mode=<span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        line = line.strip()  <span class="comment"># 去掉空格等</span></span><br><span class="line">        <span class="keyword">if</span> line.startswith(<span class="string">&quot;#&quot;</span>):  <span class="comment"># 不需要#开头的信息</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        resp_ts = requests.get(line)</span><br><span class="line">        f = <span class="built_in">open</span>(<span class="string">f&quot;4.9video_91/<span class="subst">&#123;n&#125;</span>.ts&quot;</span>, mode=<span class="string">&quot;wb&quot;</span>)</span><br><span class="line">        f.write(resp_ts.content)</span><br><span class="line">        n += <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;完成了第n个ts下载&quot;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="4-9-3-综合训练-抓取91看剧（复杂）">4.9.3 综合训练_抓取91看剧（复杂）</h4>
<p><strong>思路</strong></p>
<ol>
<li>拿到主页面的页面源代码，找到iframe</li>
<li>从iframe的源代码中拿到m3u8文件</li>
<li>下载第一层m3u8文件 -&gt; 下载第二层m3u8文件（ts存放路径）</li>
<li>下载ts文件</li>
<li>下载密钥，进行解密</li>
<li>合并ts为一个mp4</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> aiofiles</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># 获取框架内iframe的url</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_iframe_src</span>(<span class="params">ur</span>):</span><br><span class="line">    <span class="comment"># resp_iframe = requests.get(ur)</span></span><br><span class="line">    <span class="comment"># main_page = BeautifulSoup(resp_iframe.text, &quot;html.parser&quot;)</span></span><br><span class="line">    <span class="comment"># src = main_page.find(&quot;iframe&quot;).get(&quot;src&quot;)</span></span><br><span class="line">    <span class="comment"># print(src)</span></span><br><span class="line">    <span class="comment"># return src</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;https://kanju77.com/xgplayer.html?url=https://youku.sd-play.com/20220820/9jja4ALL/index.m3u8&quot;</span></span><br><span class="line"><span class="comment"># 获取第一个m3u8文件url</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_first_m3u8_url</span>(<span class="params">ur</span>):</span><br><span class="line">    <span class="comment"># resp_first_m3u8 = requests.get(ur)</span></span><br><span class="line">    <span class="comment"># print(resp_first_m3u8.text)</span></span><br><span class="line">    <span class="comment"># obj = re.compile(r&#x27;var main = &quot;(?P&lt;m3u8_url&gt;.*?)&quot;&#x27;, re.S)</span></span><br><span class="line">    <span class="comment"># m3u8_url = obj.search(resp_first_m3u8.text).group(&quot;m3u8_url&quot;)</span></span><br><span class="line">    m3u8_url = ur.split(<span class="string">&quot;=&quot;</span>)[-<span class="number">1</span>]</span><br><span class="line">    <span class="comment"># print(m3u8_url)</span></span><br><span class="line">    <span class="keyword">return</span> m3u8_url</span><br><span class="line"><span class="comment"># 下载m3u8文件</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_m3u8_file</span>(<span class="params">ur, name</span>):</span><br><span class="line">    resp = requests.get(ur)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;4.9.3video_91/&quot;</span> + name, mode=<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(resp.content)</span><br><span class="line"><span class="comment"># 异步下载ts文件</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">download_ts</span>(<span class="params">ur, fname, sess</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> sess.get(ur, verify_ssl=<span class="literal">False</span>) <span class="keyword">as</span> resp:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiofiles.<span class="built_in">open</span>(<span class="string">f&quot;4.9.3video_91/<span class="subst">&#123;fname&#125;</span>&quot;</span>, mode=<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">await</span> f.write(<span class="keyword">await</span> resp.content.read())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;fname&#125;</span>下载完毕&quot;</span>)</span><br><span class="line"><span class="comment"># 读取m3u8文件进行异步下载主框架</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">aio_download</span>(<span class="params">name</span>):</span><br><span class="line">    tasks = []</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:  <span class="comment"># 提前准备好session</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiofiles.<span class="built_in">open</span>(name, mode=<span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">                <span class="keyword">if</span> line.startswith(<span class="string">&quot;#&quot;</span>):</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                ts_url = line.strip()</span><br><span class="line">                task = asyncio.create_task(download_ts(ts_url, line.split(<span class="string">&quot;/&quot;</span>)[-<span class="number">1</span>].strip(), session))</span><br><span class="line">                tasks.append(task)</span><br><span class="line">            <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"><span class="comment"># 获取key.key文件中的密钥</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_key</span>(<span class="params">ur</span>):</span><br><span class="line">    resp = requests.get(ur)</span><br><span class="line">    <span class="keyword">return</span> resp.text</span><br><span class="line"><span class="comment"># 异步解密ts文件</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">decode_ts</span>(<span class="params">fn, k</span>):</span><br><span class="line">    aes = AES.new(key=k.encode(<span class="string">&quot;utf-8&quot;</span>), IV=<span class="string">b&quot;0000000000000000&quot;</span>, mode=AES.MODE_CBC)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiofiles.<span class="built_in">open</span>(<span class="string">f&quot;4.9.3video_91/<span class="subst">&#123;fn&#125;</span>&quot;</span>, mode=<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f1, \</span><br><span class="line">            aiofiles.<span class="built_in">open</span>(<span class="string">f&quot;4.9.3video_91/temp_<span class="subst">&#123;fn&#125;</span>&quot;</span>, mode=<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f2:</span><br><span class="line">        bs = <span class="keyword">await</span> f1.read()  <span class="comment"># 从源文件读取</span></span><br><span class="line">        <span class="keyword">await</span> f2.write(aes.decrypt(bs))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;fn&#125;</span> over!&quot;</span>)</span><br><span class="line"><span class="comment"># 读取m3u8文件进行异步解密文件</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">aio_decode</span>(<span class="params">k</span>):</span><br><span class="line">    tasks = []</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiofiles.<span class="built_in">open</span>(<span class="string">&quot;4.9.3video_91/second.m3u8&quot;</span>, mode=<span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            <span class="keyword">if</span> line.startswith(<span class="string">&quot;#&quot;</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            fname = line.split(<span class="string">&quot;/&quot;</span>)[-<span class="number">1</span>].strip()</span><br><span class="line">            <span class="comment"># 开始创建异步任务</span></span><br><span class="line">            task = asyncio.create_task(decode_ts(fname, k))</span><br><span class="line">            tasks.append(task)</span><br><span class="line">        <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"><span class="comment"># 终端命令合并ts文件为mp4</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge_ts</span>():</span><br><span class="line">    <span class="comment"># mac: cat 1.ts 2.ts 3.ts &gt; xxx.mp4(正则&quot;*.ts&quot;)</span></span><br><span class="line">    <span class="comment"># windows: copy /b 1.ts+2.ts+3.ts xxx.mp4</span></span><br><span class="line">    lst = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;4.9.3video_91/second.m3u8&quot;</span>, mode=<span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            <span class="keyword">if</span> line.startswith(<span class="string">&quot;#&quot;</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            fname = line.split(<span class="string">&quot;/&quot;</span>)[-<span class="number">1</span>].strip()</span><br><span class="line">            lst.append(<span class="string">f&quot;4.9.3video_91/temp_<span class="subst">&#123;fname&#125;</span>&quot;</span>)</span><br><span class="line">    s = <span class="string">&quot; &quot;</span>.join(lst)</span><br><span class="line">    os.system(<span class="string">f&quot;cat <span class="subst">&#123;s&#125;</span> &gt; 4.9.3video_91/movie.mp4&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;all over!&quot;</span>)</span><br><span class="line"><span class="comment"># 主函数框架</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">ur</span>):</span><br><span class="line">    <span class="comment"># 主页面源代码 -&gt; iframe url</span></span><br><span class="line">    iframe_src = get_iframe_src(ur)</span><br><span class="line">    <span class="comment"># 拿到第一层的m3u8文件</span></span><br><span class="line">    first_m3u8_url = get_first_m3u8_url(iframe_src)</span><br><span class="line">    <span class="comment"># 下载第一层m3u8</span></span><br><span class="line">    download_m3u8_file(first_m3u8_url, <span class="string">&quot;first.m3u8&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;m3u8_1 over&quot;</span>)</span><br><span class="line">    <span class="comment"># 下载第二层m3u8</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;4.9.3video_91/first.m3u8&quot;</span>, mode=<span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            <span class="keyword">if</span> line.startswith(<span class="string">&quot;#&quot;</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                line = line.strip()</span><br><span class="line">                <span class="comment"># 拼接第二层m3u8下载路径</span></span><br><span class="line">                second_m3u8_url = first_m3u8_url.split(<span class="string">&quot;/20220820/&quot;</span>)[<span class="number">0</span>] + line</span><br><span class="line">                download_m3u8_file(second_m3u8_url, <span class="string">&quot;second.m3u8&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;m3u8_2 over&quot;</span>)</span><br><span class="line">    <span class="comment"># 异步协程下载ts启动</span></span><br><span class="line">    asyncio.run(aio_download(<span class="string">&quot;4.9.3video_91/second.m3u8&quot;</span>))</span><br><span class="line">    <span class="comment"># 拿到密钥</span></span><br><span class="line">    key_url = second_m3u8_url.replace(<span class="string">&quot;index.m3u8&quot;</span>, <span class="string">&quot;key.key&quot;</span>)</span><br><span class="line">    key = get_key(key_url)</span><br><span class="line">    <span class="comment"># 异步解密启动</span></span><br><span class="line">    asyncio.run(aio_decode(key))</span><br><span class="line">    <span class="comment"># 合并ts文件</span></span><br><span class="line">    merge_ts()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    url = <span class="string">&quot;https://f.vhttps.com/vy/113082-2-1/&quot;</span></span><br><span class="line">   	main(url)</span><br></pre></td></tr></table></figure>
<h2 id="第五章-selenium">第五章 selenium</h2>
<h3 id="5-1-selenium引入">5.1 selenium引入</h3>
<p>能不能让我的程序连接到浏览器，让浏览器来完成各种复杂的操作，我们只接受最终的成果?</p>
<p><strong>selenium</strong>：自动化测试工具 -&gt; 打开浏览器，像人一样去操作浏览器。程序员可以从selenium中直接提取网页上的各种信息</p>
<p><strong>环境搭建：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install selenium</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://registry.npmmirror.com/binary.html?path=chromedriver/">下载浏览器驱动</a>	把解压缩的浏览器驱动 chromedriver 放在python解释器所在文件夹</p>
<p>让selenium启动谷歌浏览器:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> Chrome</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.创建浏览器对象</span></span><br><span class="line">web = Chrome()</span><br><span class="line"><span class="comment"># 2.打开一个网址</span></span><br><span class="line">web.get(<span class="string">&quot;http://www.baidu.com&quot;</span>)</span><br><span class="line"><span class="comment"># 3.输出网站名称</span></span><br><span class="line"><span class="built_in">print</span>(web.title)</span><br></pre></td></tr></table></figure>
<h3 id="5-2-selenium各种操作-抓拉钩">5.2 selenium各种操作_抓拉钩</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> Chrome</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.keys <span class="keyword">import</span> Keys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">web = Chrome()</span><br><span class="line">web.get(<span class="string">&quot;http://lagou.com&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 找到某个元素，并点击</span></span><br><span class="line">el = web.find_element(By.XPATH, <span class="string">&#x27;//*[@id=&quot;changeCityBox&quot;]/p[1]/a&#x27;</span>)</span><br><span class="line">el.click()  <span class="comment"># 点击事件</span></span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">1</span>)  <span class="comment"># 让浏览器完全加载完</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 找到输入框，输入python -&gt; 输入回车/点击搜索按钮</span></span><br><span class="line">web.find_element(By.XPATH, <span class="string">&#x27;//*[@id=&quot;search_input&quot;]&#x27;</span>).send_keys(<span class="string">&quot;python&quot;</span>, Keys.ENTER)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找存放数据的位置，进行数据提取</span></span><br><span class="line"><span class="comment"># 找到数据条</span></span><br><span class="line">div_lst = web.find_elements(By.XPATH, <span class="string">&#x27;//*[@id=&quot;jobList&quot;]/div[1]/div&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> div <span class="keyword">in</span> div_lst:</span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    job_name = div.find_element(By.TAG_NAME, <span class="string">&quot;a&quot;</span>).text</span><br><span class="line">    job_price = div.find_element(By.XPATH, <span class="string">&#x27;./div[1]/div[1]/div[2]/span&#x27;</span>).text</span><br><span class="line">    job_company = div.find_element(By.XPATH, <span class="string">&#x27;./div[1]/div[2]/div[1]/a&#x27;</span>).text</span><br><span class="line">    <span class="built_in">print</span>(job_company, job_name, job_price)</span><br></pre></td></tr></table></figure>
<h3 id="5-3-selenium-窗口之间的切换">5.3 selenium_窗口之间的切换</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> Chrome</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="comment"># 打开网页</span></span><br><span class="line">web = Chrome()</span><br><span class="line">web.get(<span class="string">&quot;http://lagou.com&quot;</span>)</span><br><span class="line"><span class="comment"># 关闭窗口</span></span><br><span class="line">web.find_element(By.XPATH, <span class="string">&#x27;//*[@id=&quot;cboxClose&quot;]&#x27;</span>).click()</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 搜索python并点击信息跳转新窗口</span></span><br><span class="line">web.find_element(By.XPATH, <span class="string">&#x27;//*[@id=&quot;search_input&quot;]&#x27;</span>).send_keys(<span class="string">&#x27;python\n&#x27;</span>)</span><br><span class="line">time.sleep(<span class="number">0.8</span>)</span><br><span class="line">web.find_element(By.XPATH, <span class="string">&#x27;//*[@id=&quot;jobList&quot;]/div[1]/div[1]/div[1]/div[1]/div[1]/a&#x27;</span>).click()</span><br></pre></td></tr></table></figure>
<p>如何进入新窗口提取内容？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意，在selenium的眼中，新窗口默认是不切换的，虽然浏览器页面已切换</span></span><br><span class="line">web.switch_to.window(web.window_handles[-<span class="number">1</span>])</span><br><span class="line"><span class="comment"># 新窗口提取</span></span><br><span class="line">job_detail = web.find_element(By.XPATH, <span class="string">&#x27;//*[@id=&quot;job_detail&quot;]/dd[2]/div&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(job_detail.text)</span><br><span class="line"><span class="comment"># 关闭新窗口</span></span><br><span class="line">web.close()</span><br><span class="line"><span class="comment"># 变更selenium视角回到原窗口</span></span><br><span class="line">web.switch_to.window(web.window_handles[<span class="number">0</span>])</span><br><span class="line"><span class="built_in">print</span>(web.find_element(By.XPATH, <span class="string">&#x27;//*[@id=&quot;jobList&quot;]/div[1]/div[1]/div[1]/div[1]/div[1]/a&#x27;</span>).text)</span><br></pre></td></tr></table></figure>
<p>如果页面中遇到了iframe怎么处理？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">web.get(<span class="string">&quot;https://f.vhttps.com/vy/113082-2-1/&quot;</span>)</span><br><span class="line"><span class="comment"># 处理iframe需要先拿到iframe，然后切换视角到iframe，再从中拿数据</span></span><br><span class="line">iframe = web.find_element(By.XPATH, <span class="string">&#x27;//*[@id=&quot;playleft&quot;]/iframe&#x27;</span>)</span><br><span class="line">web.switch_to.frame(iframe)</span><br><span class="line"><span class="built_in">print</span>(web.find_element(By.XPATH, <span class="string">&#x27;/html/head/title&#x27;</span>).text)</span><br><span class="line"><span class="comment"># web.switch_to.default_content()  # 切换回默认页面</span></span><br></pre></td></tr></table></figure>
<h3 id="5-4-无头浏览器">5.4 无头浏览器</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.options <span class="keyword">import</span> Options</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> Chrome</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.select <span class="keyword">import</span> Select</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="comment"># 准备好参数配置</span></span><br><span class="line">opt = Options()</span><br><span class="line">opt.add_argument(<span class="string">&quot;--headless&quot;</span>)</span><br><span class="line">opt.add_argument(<span class="string">&quot;--disable-gpu&quot;</span>)</span><br><span class="line">web = Chrome(options=opt)  <span class="comment"># 把参数设置到浏览器：不弹出浏览器窗口</span></span><br><span class="line">web.get(<span class="string">&quot;https://ys.endata.cn/BoxOffice/Ranking&quot;</span>)</span><br><span class="line"><span class="comment"># 定位到下拉列表</span></span><br><span class="line">sel_el = web.find_element(By.XPATH, <span class="string">&quot;xxx&quot;</span>)</span><br><span class="line"><span class="comment"># 对元素进行包装</span></span><br><span class="line">sel = Select(sel_el)</span><br><span class="line"><span class="comment"># 让浏览器进行调整选项</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(sel.options)):  <span class="comment"># i为下拉选框的索引位置</span></span><br><span class="line">    sel.select_by_index(i)  <span class="comment"># 根据索引切换</span></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    table = web.find_element(By.XPATH, <span class="string">&#x27;xxxx&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(table.text)</span><br><span class="line">web.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如何拿到页面代码元素（经过数据加载和js执行后的html内容）</span></span><br><span class="line"><span class="built_in">print</span>(web.page_source)</span><br></pre></td></tr></table></figure>
<h3 id="5-5-超级鹰处理验证码">5.5 超级鹰处理验证码</h3>
<p>1.图像识别</p>
<p>2.选择互联网上成熟的验证码破解工具——<a href="/Users/lzh/Documents/workSpace/pycharm/crawl/%E7%AC%AC%E4%BA%94%E7%AB%A0">超级鹰.py</a></p>
<h3 id="5-6-超级鹰处理超级鹰">5.6 超级鹰处理超级鹰</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.options <span class="keyword">import</span> Options</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> Chrome</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> chaojiying <span class="keyword">import</span> Chaojiying_Client</span><br><span class="line">opt = Options()  <span class="comment"># 避免浏览器自动关闭</span></span><br><span class="line">opt.add_experimental_option(<span class="string">&quot;detach&quot;</span>, <span class="literal">True</span>)</span><br><span class="line">web = Chrome(options=opt)</span><br><span class="line">web.get(<span class="string">&quot;http://www.chaojiying.com/user/login/&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理验证码</span></span><br><span class="line">img = web.find_element(By.XPATH, <span class="string">&#x27;/html/body/div[3]/div/div[3]/div[1]/form/div/img&#x27;</span>).screenshot_as_png</span><br><span class="line">chaojiying = Chaojiying_Client(<span class="string">&#x27;19997617865&#x27;</span>, <span class="string">&#x27;thebest1&#x27;</span>, <span class="string">&#x27;938270&#x27;</span>)</span><br><span class="line">dic = chaojiying.PostPic(img, <span class="number">1902</span>)</span><br><span class="line">verify_code = dic[<span class="string">&#x27;pic_str&#x27;</span>]</span><br><span class="line"><span class="comment"># 向页面中填充信息</span></span><br><span class="line">web.find_element(By.XPATH, <span class="string">&#x27;/html/body/div[3]/div/div[3]/div[1]/form/p[1]/input&#x27;</span>).send_keys(<span class="string">&quot;19997617865&quot;</span>)</span><br><span class="line">web.find_element(By.XPATH, <span class="string">&#x27;/html/body/div[3]/div/div[3]/div[1]/form/p[2]/input&#x27;</span>).send_keys(<span class="string">&quot;thebest1&quot;</span>)</span><br><span class="line">web.find_element(By.XPATH, <span class="string">&#x27;/html/body/div[3]/div/div[3]/div[1]/form/p[3]/input&#x27;</span>).send_keys(verify_code)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 点击登陆</span></span><br><span class="line">web.find_element(By.XPATH, <span class="string">&#x27;/html/body/div[3]/div/div[3]/div[1]/form/p[4]/input&#x27;</span>).click()</span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<h3 id="5-7-搞定12306的登陆问题">5.7 搞定12306的登陆问题</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.options <span class="keyword">import</span> Options</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> Chrome</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.action_chains <span class="keyword">import</span> ActionChains</span><br><span class="line"><span class="keyword">from</span> chaojiying <span class="keyword">import</span> Chaojiying_Client</span><br><span class="line"><span class="comment"># 初始化超级鹰</span></span><br><span class="line">chaojiying = Chaojiying_Client(<span class="string">&quot;19997617865&quot;</span>, <span class="string">&quot;thebest1&quot;</span>, <span class="string">&quot;938270&quot;</span>)</span><br><span class="line"><span class="comment"># # 如果程序被识别，chrome的版本大等于88</span></span><br><span class="line"><span class="comment"># opt = Options()</span></span><br><span class="line"><span class="comment"># opt.add_experimental_option(&#x27;excludeSwitches&#x27;, [&#x27;enable-automation&#x27;])</span></span><br><span class="line"><span class="comment"># opt.add_argument(&#x27;--disable-blink-features=AutomationControlled&#x27;)</span></span><br><span class="line"><span class="comment"># web = Chrome(options=opt)</span></span><br><span class="line">opt = Options()  <span class="comment"># 避免浏览器自动关闭</span></span><br><span class="line">opt.add_experimental_option(<span class="string">&quot;detach&quot;</span>, <span class="literal">True</span>)</span><br><span class="line">web = Chrome(options=opt)</span><br><span class="line">web.get(<span class="string">&quot;https://kyfw.12306.cn/otn/resources/login.html&quot;</span>)</span><br><span class="line">time.sleep(<span class="number">2</span>)</span><br><span class="line">web.find_element(By.XPATH, <span class="string">&#x27;//*[@id=&quot;toolbar_Div&quot;]/div[2]/div[2]/ul/li[1]/a&#x27;</span>).click()</span><br><span class="line">time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 先处理验证码</span></span><br><span class="line">verify_img_content = web.find_element(By.XPATH, <span class="string">&#x27;img_xpath&#x27;</span>)</span><br><span class="line"><span class="comment"># 用超级鹰去识别验证码</span></span><br><span class="line">dic = chaojiying.PostPic(verify_img_content.screenshot_as_png, <span class="number">9004</span>)</span><br><span class="line">result = dic[<span class="string">&#x27;pic_str&#x27;</span>]  <span class="comment"># [xi,yi]...</span></span><br><span class="line">rs_lst = result.split(<span class="string">&quot;|&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> rs <span class="keyword">in</span> rs_lst:</span><br><span class="line">    tmp = rs.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">    x = <span class="built_in">int</span>(tmp[<span class="number">0</span>])</span><br><span class="line">    y = <span class="built_in">int</span>(tmp[<span class="number">1</span>])</span><br><span class="line">    <span class="comment"># 鼠标移动至坐标点并点击</span></span><br><span class="line">    <span class="comment"># 事件链</span></span><br><span class="line">    ActionChains(web).move_to_element_with_offset(verify_img_content, x, y).click().perform()</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 输入用户名和密码</span></span><br><span class="line">web.find_element(By.XPATH, <span class="string">&#x27;//*[@id=&quot;J-userName&quot;]&#x27;</span>).send_keys(<span class="string">&#x27;19997617865&#x27;</span>)</span><br><span class="line">web.find_element(By.XPATH, <span class="string">&#x27;//*[@id=&quot;J-password&quot;]&#x27;</span>).send_keys(<span class="string">&#x27;thebest1&#x27;</span>)</span><br><span class="line"><span class="comment"># 点击登录</span></span><br><span class="line">web.find_element(By.XPATH, <span class="string">&#x27;//*[@id=&quot;J-login&quot;]&#x27;</span>).click()</span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line"><span class="comment"># 拖拽</span></span><br><span class="line">btn = web.find_element(By.XPATH, <span class="string">&#x27;//*[@id=&quot;nc_1_n1z&quot;]&#x27;</span>)</span><br><span class="line">ActionChains(web).drag_and_drop_by_offset(btn, <span class="number">300</span>, <span class="number">0</span>).perform()</span><br></pre></td></tr></table></figure>
<h2 id="专题：干b站视频">专题：干b站视频</h2>
<h3 id="步骤：">步骤：</h3>
<ol>
<li>弄明白b站如何加载视频：</li>
<li>抓包工具抓包/拿源代码</li>
<li>写正则</li>
<li>转化为字典，url</li>
<li>下载视频音频</li>
<li>合并起来</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://lzh594.github.io">£·</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://lzh594.github.io/python/%E7%88%AC%E8%99%AB%E7%AC%94%E8%AE%B0/">https://lzh594.github.io/python/%E7%88%AC%E8%99%AB%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lzh594.github.io" target="_blank">lzhのBLOG</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/crawl/">crawl</a></div><div class="post_share"><div class="social-share" data-image="/images/funingna.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/BUAA/OS/OS/" title="OS复习"><img class="cover" src="/images/naweiya.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">OS复习</div></div></a></div><div class="next-post pull-right"><a href="/BUAA/Tencent/%20%E8%85%BE%E8%AE%AF%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2Hexo/" title=""><img class="cover" src="/images/syq2.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info"></div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/images/touxiang1.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">£·</div><div class="author-info__description">欢迎访问～</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">23</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/lzh594/"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/lzh594" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">lzh's Blog 来噜！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC1%E7%AB%A0-%E5%88%9D%E8%AF%86%E7%88%AC%E8%99%AB"><span class="toc-number">1.</span> <span class="toc-text">第1章 初识爬虫</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E7%AC%AC%E4%B8%80%E4%B8%AA%E7%88%AC%E8%99%AB%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 第一个爬虫程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-web%E8%AF%B7%E6%B1%82%E8%BF%87%E7%A8%8B%E5%89%96%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 web请求过程剖析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-HTTP%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 HTTP协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-requests%E5%85%A5%E9%97%A801"><span class="toc-number">1.4.</span> <span class="toc-text">1.4 requests入门01</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-requests%E5%85%A5%E9%97%A802"><span class="toc-number">1.5.</span> <span class="toc-text">1.5 requests入门02</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-requests%E5%85%A5%E9%97%A803"><span class="toc-number">1.6.</span> <span class="toc-text">1.6 requests入门03</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7-%E8%A1%A5%E5%85%85"><span class="toc-number">1.7.</span> <span class="toc-text">1.7 补充</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC2%E7%AB%A0-%E6%95%B0%E6%8D%AE%E8%A7%A3%E6%9E%90%E4%B8%8E%E6%8F%90%E5%8F%96"><span class="toc-number">2.</span> <span class="toc-text">第2章 数据解析与提取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E6%95%B0%E6%8D%AE%E8%A7%A3%E6%9E%90%E6%A6%82%E8%BF%B0"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 数据解析概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 正则表达式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-re%E6%A8%A1%E5%9D%97"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 re模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-re%E5%AE%9E%E4%BE%8B"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 re实例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-%E6%89%8B%E5%88%83%E8%B1%86%E7%93%A3TOP250"><span class="toc-number">2.4.1.</span> <span class="toc-text">2.4.1 手刃豆瓣TOP250</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-%E5%B1%A0%E6%88%AE%E7%94%B5%E5%BD%B1%E5%A4%A9%E5%A0%82"><span class="toc-number">2.4.2.</span> <span class="toc-text">2.4.2 屠戮电影天堂</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-bs4%E8%A7%A3%E6%9E%90-HTML%E8%AF%AD%E6%B3%95"><span class="toc-number">2.5.</span> <span class="toc-text">2.5 bs4解析_HTML语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-bs4%E8%A7%A3%E6%9E%90-%E6%96%B0%E5%8F%91%E5%9C%B0"><span class="toc-number">2.6.</span> <span class="toc-text">2.6 bs4解析_新发地</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-bs4%E8%A7%A3%E6%9E%90-%E6%8A%93%E5%8F%96%E4%BC%98%E7%BE%8E%E5%9B%BE%E5%BA%93"><span class="toc-number">2.7.</span> <span class="toc-text">2.7 bs4解析_抓取优美图库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-xpath%E8%A7%A3%E6%9E%90"><span class="toc-number">2.8.</span> <span class="toc-text">2.8 xpath解析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-8-1-xpath%E8%A7%A3%E6%9E%90%E5%85%A5%E9%97%A81"><span class="toc-number">2.8.1.</span> <span class="toc-text">2.8.1 xpath解析入门1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-8-1-xpath%E8%A7%A3%E6%9E%90%E5%85%A5%E9%97%A82"><span class="toc-number">2.8.2.</span> <span class="toc-text">2.8.1 xpath解析入门2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-xpath%E8%A7%A3%E6%9E%90%E5%AE%9E%E4%BE%8B-%E5%B9%B2%E7%8C%AA%E5%85%AB%E6%88%92"><span class="toc-number">2.9.</span> <span class="toc-text">2.9 xpath解析实例_干猪八戒</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC3%E7%AB%A0-requests%E6%A8%A1%E5%9D%97%E8%BF%9B%E9%98%B6"><span class="toc-number">3.</span> <span class="toc-text">第3章 requests模块进阶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-requests%E8%BF%9B%E9%98%B6%E6%A6%82%E8%BF%B0"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 requests进阶概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E6%A8%A1%E6%8B%9F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95-%E5%A4%84%E7%90%86cookie"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 模拟用户登录_处理cookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E9%98%B2%E7%9B%97%E9%93%BE%E5%A4%84%E7%90%86-%E6%8A%93%E5%8F%96%E6%A2%A8%E8%A7%86%E9%A2%91"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 防盗链处理_抓取梨视频</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E4%BB%A3%E7%90%86"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E7%BB%BC%E5%90%88%E8%AE%AD%E7%BB%83-%E6%8A%93%E5%8F%96%E7%BD%91%E6%98%93%E4%BA%91%E9%9F%B3%E4%B9%90%E7%83%AD%E8%AF%84"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 综合训练_抓取网易云音乐热评</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC4%E7%AB%A0-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E5%A4%9A%E8%BF%9B%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">第4章 多线程与多进程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E7%BA%BF%E7%A8%8B%E4%B8%8E%E8%BF%9B%E7%A8%8B"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 线程与进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 多线程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-%E5%8D%95%E7%BA%BF%E7%A8%8B"><span class="toc-number">4.2.1.</span> <span class="toc-text">4.2.1 单线程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-%E5%A4%9A%E7%BA%BF%E7%A8%8B1"><span class="toc-number">4.2.2.</span> <span class="toc-text">4.2.2 多线程1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-3-%E5%A4%9A%E7%BA%BF%E7%A8%8B2"><span class="toc-number">4.2.3.</span> <span class="toc-text">4.2.3 多线程2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%92%8C%E8%BF%9B%E7%A8%8B%E6%B1%A0"><span class="toc-number">4.3.</span> <span class="toc-text">4.4 线程池和进程池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%92%8C%E8%BF%9B%E7%A8%8B%E6%B1%A0%E5%AE%9E%E4%BE%8B-%E6%96%B0%E5%8F%91%E5%9C%B0%E8%8F%9C%E4%BB%B7"><span class="toc-number">4.4.</span> <span class="toc-text">4.5 线程池和进程池实例_新发地菜价</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-%E5%8D%8F%E7%A8%8B"><span class="toc-number">4.5.</span> <span class="toc-text">4.6 协程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7-%E5%BC%82%E6%AD%A5http%E8%AF%B7%E6%B1%82-aiohttp%E6%A8%A1%E5%9D%97%E8%AE%B2%E8%A7%A3"><span class="toc-number">4.6.</span> <span class="toc-text">4.7 异步http请求_aiohttp模块讲解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-8%E5%BC%82%E6%AD%A5%E7%88%AC%E8%99%AB%E5%AE%9E%E6%88%98-%E6%89%92%E5%85%89%E4%B8%80%E9%83%A8%E5%B0%8F%E8%AF%B4"><span class="toc-number">4.7.</span> <span class="toc-text">4.8异步爬虫实战_扒光一部小说</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-9-%E7%BB%BC%E5%90%88%E8%AE%AD%E7%BB%83-%E6%8A%93%E5%8F%9691%E8%A7%86%E9%A2%91"><span class="toc-number">4.8.</span> <span class="toc-text">4.9 综合训练_抓取91视频</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-9-1-%E7%BB%BC%E5%90%88%E8%AE%AD%E7%BB%83-%E8%A7%86%E9%A2%91%E7%BD%91%E7%AB%99%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">4.8.1.</span> <span class="toc-text">4.9.1 综合训练_视频网站的工作原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-9-2-%E7%BB%BC%E5%90%88%E8%AE%AD%E7%BB%83-%E6%8A%93%E5%8F%9691%E7%9C%8B%E5%89%A7%EF%BC%88%E7%AE%80%E5%8D%95%EF%BC%89"><span class="toc-number">4.8.2.</span> <span class="toc-text">4.9.2 综合训练_抓取91看剧（简单）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-9-3-%E7%BB%BC%E5%90%88%E8%AE%AD%E7%BB%83-%E6%8A%93%E5%8F%9691%E7%9C%8B%E5%89%A7%EF%BC%88%E5%A4%8D%E6%9D%82%EF%BC%89"><span class="toc-number">4.8.3.</span> <span class="toc-text">4.9.3 综合训练_抓取91看剧（复杂）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E7%AB%A0-selenium"><span class="toc-number">5.</span> <span class="toc-text">第五章 selenium</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-selenium%E5%BC%95%E5%85%A5"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 selenium引入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-selenium%E5%90%84%E7%A7%8D%E6%93%8D%E4%BD%9C-%E6%8A%93%E6%8B%89%E9%92%A9"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 selenium各种操作_抓拉钩</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-selenium-%E7%AA%97%E5%8F%A3%E4%B9%8B%E9%97%B4%E7%9A%84%E5%88%87%E6%8D%A2"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 selenium_窗口之间的切换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E6%97%A0%E5%A4%B4%E6%B5%8F%E8%A7%88%E5%99%A8"><span class="toc-number">5.4.</span> <span class="toc-text">5.4 无头浏览器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-%E8%B6%85%E7%BA%A7%E9%B9%B0%E5%A4%84%E7%90%86%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-number">5.5.</span> <span class="toc-text">5.5 超级鹰处理验证码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-%E8%B6%85%E7%BA%A7%E9%B9%B0%E5%A4%84%E7%90%86%E8%B6%85%E7%BA%A7%E9%B9%B0"><span class="toc-number">5.6.</span> <span class="toc-text">5.6 超级鹰处理超级鹰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-%E6%90%9E%E5%AE%9A12306%E7%9A%84%E7%99%BB%E9%99%86%E9%97%AE%E9%A2%98"><span class="toc-number">5.7.</span> <span class="toc-text">5.7 搞定12306的登陆问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%93%E9%A2%98%EF%BC%9A%E5%B9%B2b%E7%AB%99%E8%A7%86%E9%A2%91"><span class="toc-number">6.</span> <span class="toc-text">专题：干b站视频</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4%EF%BC%9A"><span class="toc-number">6.1.</span> <span class="toc-text">步骤：</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/BUAA/OS/OS/" title="OS复习"><img src="/images/naweiya.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="OS复习"/></a><div class="content"><a class="title" href="/BUAA/OS/OS/" title="OS复习">OS复习</a><time datetime="2024-02-26T04:38:06.000Z" title="发表于 2024-02-26 12:38:06">2024-02-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/python/%E7%88%AC%E8%99%AB%E7%AC%94%E8%AE%B0/" title="爬虫笔记"><img src="/images/funingna.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="爬虫笔记"/></a><div class="content"><a class="title" href="/python/%E7%88%AC%E8%99%AB%E7%AC%94%E8%AE%B0/" title="爬虫笔记">爬虫笔记</a><time datetime="2024-02-25T10:05:06.000Z" title="发表于 2024-02-25 18:05:06">2024-02-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/BUAA/Tencent/%20%E8%85%BE%E8%AE%AF%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2Hexo/" title="无题"><img src="/images/syq2.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/BUAA/Tencent/%20%E8%85%BE%E8%AE%AF%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2Hexo/" title="无题">无题</a><time datetime="2024-01-30T10:35:38.570Z" title="发表于 2024-01-30 18:35:38">2024-01-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/photography/01-%E8%AE%A4%E8%AF%86%E7%9B%B8%E6%9C%BA%E3%80%81%E4%BC%A0%E6%84%9F%E5%99%A8%E5%92%8C%E9%95%9C%E5%A4%B4/" title="无题"><img src="/images/syq1.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/photography/01-%E8%AE%A4%E8%AF%86%E7%9B%B8%E6%9C%BA%E3%80%81%E4%BC%A0%E6%84%9F%E5%99%A8%E5%92%8C%E9%95%9C%E5%A4%B4/" title="无题">无题</a><time datetime="2024-01-24T10:13:06.773Z" title="发表于 2024-01-24 18:13:06">2024-01-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/BUAA/crypto/crypto/" title="crypto-密码学库"><img src="/images/syq1.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="crypto-密码学库"/></a><div class="content"><a class="title" href="/BUAA/crypto/crypto/" title="crypto-密码学库">crypto-密码学库</a><time datetime="2024-01-18T11:44:45.000Z" title="发表于 2024-01-18 19:44:45">2024-01-18</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By £·</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://lzh594.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js"></script><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>